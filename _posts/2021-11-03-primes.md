---
layout: post
title: 关于素数的杂谈
subtitle: 离谱
tags: 数论
---

(实际上是摘抄wiki)

突然想起来还没写过MR，于是来写一篇，同时写一些别的东西。

结论很多，请选择性理解（

包含MR的证明，AKS，B-PSW，以及若干个有趣的结论。

## 素性测试

众所周知，有个东西叫费马小定理。人们发现费马小定理在膜数不是素数的时候有不小的可能性是不成立的，所以就考虑用这个来判定一个数是不是素数，也就是找一些$$a$$，如果$$a^{n-1}\neq 1\pmod{n}$$，那么就说明$$n$$不是素数。

固定一个$$a$$很容易就没了。让一个$$a$$没了的数$$n$$被称为关于$$a$$的费马伪素数。

要枚举所有的$$a$$的话，还不如直接枚举$$n$$的因数，所以我们可以随几个$$a$$，越随越牛逼。这个算法称为 费马素性测试。

然而这个东西飞了，因为它会被一类称为 卡迈克尔数 的数给干翻。这一类数就是对于所有的$$a\perp n$$，都有$$a^{n-1}\equiv 1\pmod{n}$$的数$$n$$。

尽管可以证明不存在对于所有$$a$$都有$$a^{n-1}\equiv 1\pmod{n}$$的合数，卡迈克尔数还是很要命，因为面对卡迈克尔数，费马素性测试相当于在随机找这个数的因子。

卡迈克尔数有无限个，并且可以证明$$n$$以内的卡迈克尔数个数是$$\Omega(n^{\frac{2}{7}})$$。判定一个数$$n$$是不是卡迈克尔数，它首先不能有平方因子，然后对于它的所有质因子$$p$$，都有$$p-1\mid n-1$$，所以它可以使用Pollard-rho在期望$$O(n^{\frac{1}{4}})$$时间内计算，或者埃筛做到$$O(n\log\log n)$$处理前$$n$$个，我不理解是否有线筛做法。

那么如何才能把费马素性测试变得更好呢?显然的想法是换一个结论或者加上更多的结论，这导出了很多不同的素性测试，我们来扯一下MR，B-PSW和AKS。

-----

MR基于一个费马小定理的加强版，称为 二次探测定理。草我怎么记得hash table里面有个二次探查（

费马小定理说明$$a^{n-1}\equiv 1\pmod{n}$$，而二次探测对这个$$1$$继续做点手脚。我们知道膜素数下$$1$$的平方根必然是$$\pm 1$$，因为如果$$x^2\equiv 1\pmod{n}$$，那么$$(x+1)(x-1)\bmod{n}=0$$，如果$$n$$是素数那么$$x+1,x-1$$必然有一个$$0$$，否则它们可以是积为$$n$$的两个数。

要做素性测试，$$n$$首先得是奇数，于是$$n-1$$就是偶数，我们假设它是$$2^km$$。可以对$$a^{2^km}$$进行$$k$$次开平方根，每次将指数减半，如果某一次得到了$$1$$之外的数并且这个数不是$$-1$$，那么就完蛋了，否则啥事没有。如果它是$$-1$$，那么接下来开出什么都是有可能的。

怎么开平方根?我们反过来，求出$$a^m$$即可。用快速幂的话这是单次一个$$\log$$的，这里认为加减乘除是$$O(1)$$的。

可以证明对于每个合数，在所有与它互质的基数$$a$$中(不互质的情况可以求一个$$\gcd$$来判掉)，都有至少$$3/4$$的$$a$$可以证明它是合数，并且在大部分数上这个比例要更高，大概是$$7/8$$。怎么证?一会再说。

有些时候我们会想要确定性的MR，因为随机的正确性实在是不能保证。选取七个素数$$2,325,9375,28178,450775,9780504,1795265022$$就可以覆盖$$2^{64}$$，但是这七个素数不太好记，场上可以选取前十二个素数。注意在实现的时候，比如要测试$$114514$$的素性，我们不能跳过比它大的基数比如$$1795265022$$，而是应该先把这个数对$$114514$$取膜，如果得到结果是$$0$$则跳过，否则正常进行。

实际上MR有一个任意值域的确定性版本，它断言测试前$$O(\log^2 n)$$个数就足够了，但是它速度上很慢，正确性上又依赖于未证明的结论(广义黎曼猜想，我也不知道那是什么)，所以没啥用。

-----

这一部分是MR正确率的证明。算导上有一个简单的$$\frac{1}{2}$$的证明，不过那个没啥意思（

证明的构造上来看会比较奇怪，不过看到后面你会全明白了。思路也很粗暴，就是先放缩成能算的东西，然后硬算。

**定理** 对于一个$$>9$$的奇合数$$n=2^km+1$$($$m$$是奇数)，有不超过$$\frac{\varphi(n)}{4}$$个和$$n$$互质的数$$x$$，满足$$x^m=1$$或者某个$$x^{m2^i}=-1$$，其中$$0\leq i<k$$。

**证明** 放缩一下。考虑$$n$$的分解，对于它的每个质因数$$p$$，我们从$$p-1$$中尽可能提取$$2$$，设提取了$$l_p$$个，取最小的$$l_p$$设为$$l$$。

考虑方程$$x^{m2^{l-1}}\equiv\pm 1\pmod(n)$$，容易发现满足$$x^m=1$$的$$x$$必然满足这个方程。

而对于满足某个$$x^{m2^i}\equiv -1$$的$$x$$，为了证明它也满足这个方程，我们显然是希望证明$$i\leq l-1$$，这样就有$$x^{m2^{l-1}}\equiv (-1)^{2^{l-i-1}}\equiv\pm 1$$。

考虑$$x^{m2^{i+1}}$$膜$$n$$的任意一个质因子$$p$$得到$$1$$，$$x^{m2^i}$$膜$$n$$的任意一个质因子$$p$$也得到$$-1$$，这说明$$x$$膜$$p$$的阶是$$2^{i+1}$$的因数而又不是$$2^i$$的因数，所以这个阶必然就是$$2^{i+1}$$。同时$$x$$膜$$p$$的阶应该是$$p-1$$的因数，所以$$2^{i+1}\mid p-1$$，这就很好!

所以问题变为证明$$x^{m2^{l-1}}\equiv\pm 1\pmod{n}(x<n,x\perp n)$$的解数不超过$$\frac{\varphi(n)}{4}$$。

注意到$$x^{m2^{l-1}}\equiv 1\pmod{n}(x<n,x\perp n)$$的数，必然膜每个$$n$$中的$$p^k$$还是$$1$$，根据CRT我们知道这个反过来也成立，于是$$x^{m2^{l-1}}\equiv 1\pmod{n}(x<n,x\perp n)$$的解数等于各$$x^{m2^{l-1}}\equiv 1\pmod{p^k}(x<p^k,x\perp n)$$的解数之积。$$x^{m2^{l-1}}\equiv -1\pmod{n}(x<n,x\perp n)$$是一样的。

考虑怎么算$$x^{m2^{l-1}}\equiv 1\pmod{p^k}(x<p^k,x\perp n)$$的解数。你发现$$p^k$$存在原根，所以可以取离散对数，于是这相当于让$$\varphi(p^k)$$个$$x$$都在一个环上前进了$$m2^{l-1}$$步。

根据经典结论，从每个和$$p^k$$互质的数的起点向终点连边，会形成$$\gcd(\varphi(p),m2^{l-1})$$个环，而不互质的数不会掺和进来，因为取幂之后它们必然还包含$$p$$作为因子或者变成了$$0$$。每个环上会有一个数转到$$1$$，所以一共有$$\gcd(\varphi(p),m2^{l-1})=\gcd((p-1)p^{k-1},m2^{l-1})=\gcd(p-1,m)2^{l-1}$$个解。

所以，$$x^{m2^{l-1}}\equiv\pm 1\pmod{n}(x<n,x\perp n)$$的解数就是

$$
2\prod_{p\mid n}\gcd(p-1,m)2^{l-1}
$$

我们就要证明这个式子

$$
2\prod_{p\mid n}\frac{\gcd(p-1,m)2^{l-1}}{\varphi(n)}\leq\frac{1}{4}
$$

根据积性拆开$$\varphi$$

$$
2\prod_{p^k\parallel n}\frac{\gcd(p-1,m)2^{l-1}}{(p-1)p^{k-1}}\leq\frac{1}{4}
$$

注意到左边的每个分数，都有上面是下面的真因子，因为$$p-1$$是偶数而$$m$$是奇数，那么$$\gcd(p-1,m)$$必然是$$p-1$$的真因子，而$$2^{l-1}$$必然是$$p^{k-1}$$的因子($$l-1$$就是为了凑这个)，所以我们知道，如果$$n$$有$$c$$个质因子，那么这个式子的值必然不超过$$2^{1-c}$$，当$$c\geq 3$$的时候这个式子就必然成立了。

当$$c=2$$的时候，继续考虑两个质因子的次数，你发现它们都不能超过$$1$$，因为$$2^{1-c}$$已经是$$\frac{1}{2}$$了，如果存在一个二次因子，那么左边至多是$$\frac{1}{2}\cdot\frac{1}{3}=\frac{1}{6}$$。

现在只剩下$$n=pq$$和$$n=p^k$$的情况了。先考虑前者，化一下式子，我们要证明

$$
\frac{\gcd(p-1,m)2^l}{p-1}\cdot\frac{\gcd(q-1,m)2^l}{q-1}\leq\frac{1}{2}
$$

刚才我们说明了两个分数都是$$\frac{1}{k}$$的形式，所以如果这个式子要不成立，那么两个分数必然都是$$1$$，从而$$p-1=\gcd(p-1,m)2^l,q-1=\gcd(q-1,m)2^l$$。

一个自然的想法是从这个推出$$p,q$$相等。首先我们知道$$p-1,q-1$$中$$2$$的次数必然都是$$l$$，因为$$m$$是奇数。所以我们也知道$$p-1,q-1$$的奇数部分(除掉所有$$2$$之后剩下的部分)都是$$m$$的因子。

考虑$$pq=m2^k+1$$，我们把它对$$p-1$$的奇数部分取膜，会得到$$q\equiv 1\pmod{p-1}$$，也就是$$q-1\bmod{p-1}=0$$，反过来也是一样的。从而我们知道$$p-1,q-1$$的奇数部分互为倍数，于是它们相等。刚才已经论证了它们的$$2$$的幂次相等，于是必然有$$p=q$$。

最后是$$n=p^k$$，你发现要想让上面那个式子不成立，必然有$$p^{k-1}<4$$，所以唯一的方案是$$n=3^2=9$$，这就是为什么一开始限制$$n>9$$。

-----

B-PSW(贝利-PSW)简单粗暴，它在费马素性测试的基础上，硬拼一个Lucas素性测试。这两个测试的结合非常优秀，原因是它们的伪素数看起来性质很不同。

-----

AKS也基于一个费马小定理的加强版，但是这个足够强以至于他们导出了一个确定性并且不依赖任何未证明结论的算法。AKS的论文题目是 Primes is in P，意思是他们在多项式时间内解决了素数判定的问题。

考虑在膜素数$$n$$下，必然有$$(x+a)^n\equiv x^n+a\pmod{n}$$，这个可以用二项式定理和费马小定理得到。同时，我们发现如果$$n$$不是素数，这个式子必然不成立，因为考虑$$n$$的因子$$p$$，有