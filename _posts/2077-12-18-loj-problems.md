---
layout: post
title: 几个loj上的选做计划
subtitle: qaq
tags: 题选做
---

> 神会对努力之人微笑，这是骗人的，但我们偶然会被命运之神垂青。\
  ——吹响吧！上低音号

开坑的时候随到了这句，觉得看起来很好，于是就抄下来了（

## joi/joisc

怎么感觉joi经常被到处搬（

发现dwt已经把这些刷穿了（

joi难度是提高组到省选，而joisc类似于wc，joi open大概是省选难度。

joi open难度乱序（

-----

loj2332~2336 joi 2017 final

A. 焚风现象

注意到每次修改只会影响区间两边的间隔，于是用BiT支持区间加单点查询即可。

更简单的做法是维护差分，就变成单点修改单点查询了。

B. 准高速电车

考虑我们要想到一个车站，必然是先坐快车，再换准快车，再换慢车。也就是说，每个车站的距离，是它坐慢车到前面第一个准快车站的距离，加上这个准快车站到前面第一个快车站的距离，加上这个快车站到$$1$$的距离。

首先可以按照快车站划分成若干段。显然是往靠前的段里，尽可能往后塞准快车站是最优的。注意到每一段都是塞的越多，再塞就越没用，于是这个是上凸的，于是我们可以闵和一下，实际上它就是每次选取再塞一个答案增加最多的一段。

C. JOIOI王国

这个划分方式就是画一个单调的斜线，当然往哪个方向单调不一定，不妨假设从左上往右下斜。

注意到这是两个东西的极差，而这两个东西并起来是所有东西，也就是说要么答案是全局极差，要么全局$$\max$$和全局$$\min$$分处两个省。

于是我们钦点包含全局$$\max$$的是A省，包含全局$$\min$$的是B省，A省在左边而B省在右边。枚举A的$$\min$$，最小化B的$$\max$$。

我们先把所有可以包含在A省的位置(也就是介于全局$$\max$$和我们枚举的$$\min$$之间的)标记成1，别的标记成0，然后目标就是在只能拿1的情况下，最小化没拿到的1的$$\max$$。

你发现最小化$$\max$$这件事，等价于尽可能多拿，让外面剩下的少一些。然后考虑它的结构，每一行一定是尽可能多选，除非后面会不满足单调。我们维护每行的极长前缀1长度，那么每个位置实际上选的长度就是这个的后缀$$\min$$。怎么维护这个东西的话，可以从大到小枚举那个$$\min$$，这样每个位置都只会增加，直接爆力更新复杂度就是对的。

现在问题是怎么维护每个位置实际上被选了多少。注意到这个东西也是只增不减，于是我们还是可以强行更新，但是怎么强行更新?一个位置增加了，如果它是后缀$$\min$$，那么它到它前面那一个后缀$$\min$$都会提高一些，于是强行再对这一段扫一遍，更新一下并维护新的后缀$$\min$$就好了。除去排序，总复杂度$$O(nm)$$。

看一眼题解，另一个简单做法是二分答案，然后每个格子要么只能分到A省，要么只能分到B省，要么都可以，于是我们尽可能把只能分到A省的搞定，剩下的分到B省即可。但是我觉得我的做法也很对啊?

呃它确实是对的，但是不知道为什么它跑的就是很慢，可以在https://loj.ac/s/1325779看到。懒得实现结构体基排了。

D. 足球

先假设$$a<c$$，不然没的玩了。

注意到$$h,w$$小的可怜。

考虑这个有没有什么性质。每次球的移动一定是向着目标的方向吗?

好像不一定。考虑如果带球的代价非常大，传球的代价则很小，我们会希望尽可能传球，而可能会有一条曲折的人链恰好可以传过去这样的。

呃倒是有一个显然的性质，一个人不可能两次接球，即使他中间做了跑动。因为他完全可以在第一次接球的时候就带着球跑到第二次传球的地方。

于是考虑球的运动过程中，我们难以描述的就是一个人跑过来接了这个球，然后带了一段之后把它传出去了。现在我们知道不带球的跑动只会发生在接球的时候，并且一个人两次接球一定不优，于是这个跑过来接球的人必然是离球的落点最近的人。所以我们直接建图，用路径表示球的运动过程。

带球的代价是$$c$$，于是我们给相邻的点连$$c$$。

从$$(i,j)$$传到$$(i,k)$$的代价是$$a\vert j-k\vert+b$$再加上离$$(i,k)$$最近的人跑到$$k$$的代价，于是我们给每行再建一排点表示这行上空的球，每列也是，传球的时候进入上空花费$$b$$，每一步花费$$a$$，而落地的时候花费最近的人跑过来接球的代价。最近的人可以直接bfs掉，而最短路的部分边权只有三种，可以用三个队列代替堆，复杂度是$$O(hw)$$。

诶这个东西好像有点小问题。我们刚才说一个人不会接球两次，但是这里对于一个人接球两次的路径，算的并不是他接了第一个球再跑过去接第二个球的代价，而是他传出第一个球就无代价瞬移回到初始位置，再跑去接第二个球的代价。所以这还对吗/yiw

先写一发，你发现过了。

想一想你发现这居然还是对的。我们只需要说明有一个合法方案比这个算假了的优。考虑一个人接球的时候，一定是有一个人踢给他，于是让这个人往他最后一次出球的地方跑一段就好了，画画图你发现这是对的。这么简单的问题我想了一下午?

E. 绳

看题面感觉啥想法也没有。为什么绳长最后是$$2$$而不是$$1$$?

你发现如果是$$1$$，我们只需要把所有的都染成同一个颜色，此时就都染成一开始最多的那个颜色就行了。所以就没有难度了（

如果是$$2$$，我们可以先枚举一手两段都是啥颜色，分别记为10。然后考虑一开始每一段是什么颜色。什么样的颜色序列是可以拧成两段的?

考虑如果仅仅是要判定的话，我们可以考虑最左边的那个东西，假设它是1，那么我们往右找到最近的1，然后把它和这个1折起来。如果这中间是奇数个0，你发现我们折不起来，这样的话到最后这两个1也总是折不起来，于是必然不行。所以除了开头结尾，每一段长度必须是偶数，根据前面的构造这个必然可以折起来。我们可以先枚举一波开头，这样结尾的长度奇偶性也确定了，于是剩下的每一段都是偶数。

然后你发现，我们不光一定可以折起来，并且一定可以只把左边折到右边，除非最后只剩下一个什么和一串连续的另一个，比如10000000这样的。我们枚举这个一个什么(例子中就是1)的位置，然后右边全是0，左边强力dp，复杂度是$$O(nm^2)$$。飞了?

考虑如何优化。这个颜色有没有什么性质?显然的事情是，选了一个颜色1，确定了一个方案之后，另一个颜色0一定是不是1的所有位置上，初始颜色的众数。方案要dp听起来也很离谱，能不能贪?

能不能把第一个枚举也加入dp的状态，让转移变成二维数据结构问题?你发现感觉上这个很困难，所以就没救了。还是考虑先确定一个颜色或者贪心构造方案吧。

王卷王之言可谓切中了肯綮。注意到我们为了把一段搞成偶数长度，把一个1变成0和把一个0变成1是一样的，但是把0变成1一定有代价，而把1变成0可能会影响众数从而减少代价，于是我们钦点只会把1变成0。把所有数相邻两个一组，于是00一定不变，11一定不变，01变成00。

还有一些牛逼性质没有用来着!所有颜色的出现次数和是$$n$$，所以考虑能不能让一个颜色的计算代价是$$O(c)$$，当然$$c$$是出现次数。把连续的00放在一起处理即可。剩下的问题是求一些众数，注意到如果你删的颜色不是全局众数，那么众数还是全局众数，否则可以爆力重新求。

-----

loj2342~2346 joi 2016 final

A. 橙子装箱

强行dp，用st表维护min/max。

B. 集邮比赛2

那个1在loj也有，是joisc 2014 邮戳拉力赛。

看起来意思是，加一个字符，最大化子序列JOI的个数。

我们枚举放在哪，考虑所有经过它的子序列。如果这是一个J，我们需要知道后面的OI的个数；如果是O，我们需要知道前面的J和后面的I的个数。总之就是可以算，所以就算就行了。

C. 铁路票价

动态图最短路/jy

先搞一个最短路DAG，沿着最短路DAG走得到的都是最短路，于是剩下的问题相当于删边，查$$1$$能到多少点。

这个咋做?倒过来变成加边即可。实际上一开始就倒过来也是可以的。

D. 领地

计算几何/fn

注意这个领地个数并不是围成的区域面积，因为如果我走了一个大圈，里面并不是我的领地。

爆力怎么做?考虑每走一轮的偏移量至少应该是$$1$$，否则我直接算一轮就好了。于是我们可以考虑算前$$n+2$$轮，第$$n+3$$轮所产生的贡献和$$n+2$$轮应该是相同的，因为前面对这两轮的影响是相同的。为什么$$+2$$?因为觉得不加不太对，所以就随机加了一个数。

现在问题是折线长度1e5，我们要算1e5轮，以及算第1e5轮新增了多少。第二个可以归约到第一个。

考虑怎么算这个 前面对后面的影响。我们考虑某一轮，把它的起点平移到$$(0,0)$$，然后考虑每个方格，计算前面至少需要已经有多少轮，才能让这个方格恰好在这一轮被占领，也就是这个方格的一个角在这一轮第一次被走到，另外三个在这一轮或者这一轮之前被走到。算出这个的话就可以随手统计答案了。

考虑这个问题相当于查询一个点在某种平移下，经过最少的次数平移到另一个点，也就是查询一条斜线最下面或者最上面的点，而斜线的斜率是固定的。用hash table维护每个点所在的斜线截距(或者你可以排序离散化?)，扫描线扫过去即可，复杂度$$O(n)$$。

E. 断层

感觉难度在于理解题意（

大概说的是，地层有无穷层，每层被划分成$$n$$个长为$$1$$的段，每次会有一个断层来斜着平移这些段，问你平移完了地面上每一段原来在哪一层。

平移像是均摊线段树之类的，但是这玩意看起来没有任何均摊性质......

考虑直接枚举每一段，看它是哪里来的。你发现它可能经历过若干次平移，每次平移会递归到另一段，于是我们有了一个$$O(nq)$$的做法。

考虑$$q$$个断层会把所有的东西分成$$q^2$$个区域，每个区域内的变换是相同的。于是进行分块，复杂度$$O(n\sqrt{q})$$，离线下来一起处理每一块的话，空间是线性的，感觉上应该很快。

能不能更优呢?查一手题解，发现有1$$\log$$做法。

注意到分块里面我们是倒着强行处理这些区域，于是考虑我们直接倒着做，然后就变成了平面上有一些点，支持半平面平移，最后查询每个点的位置。诶这个问题是不是随手就做掉了，为什么一开始没想到这个......

考虑为什么随手就做掉了。两种半平面分别是$$y+x\geq k,y-x\geq k$$，操作是$$(x:=x+k,y:=y-k),(x:=x-k,y:=y-k)$$。注意到不管怎么操作，两个点的$$y+x,y-x$$相对顺序总是不变，因为左边的会越来越往左，而右边的越来越往右。同时第一个操作不影响第一个不等式，第二个操作不影响第二个不等式，于是直接两个线段树维护一下，在做第一类平移的时候，去第二类的线段树上二分出来平移的是哪一段即可。复杂度$$O(n\log n)$$。

技不如人啊/ll

-----

loj2347~2351 joi 2018 final

A. 寒冬暖炉

怎么想都像是有凸性，直接wqs二分。写一发过了（

简单做法是，我们直接从小到大取这些间隔。离谱（

B. 美术展览

按尺寸排序之后，把价值和差分掉。

C. 团子制作

问题出在，一个团子只能贡献给一串。

考虑先求出所有可能的串，然后考虑它们有什么性质。注意到这些串，横着的之间不会相互影响，竖着的也不会相互影响，并且只有在同一条斜线上的才会相互影响。于是我们只需要每条斜线状压dp一下就好了。但是这只是论述了必然能做。

继续考虑它的结构，显然这个问题是一个最大独立集。我们为每一串建一个点，那么因为只有横竖之间才有影响，这个图就是二分图，可以用网络流解决。但是这个比状压dp要劣（

考虑一条斜线，这上面的所有串在这个二分图上连起来的形态看起来很有趣。实际上这个东西直接做还是状压dp?但是画一画这个图会让你立刻理解到状压dp应该如何写（

查了一下，发现正解真的是这个/jy

D. 月票购买

首先两条路径的交必然是一个区间，也就是说我们选择的$$u$$到$$v$$的路径上置$$0$$的一定是连续的一段。

考虑我们枚举交的那一段的两个端点，然后判断这一段能不能在$$s$$到$$t$$的最短路上。这个非常爆力，但是至少它是多项式复杂度。

判断能不能在$$s$$到$$t$$的最短路上这件事，爆力就是Floyd，那么有没有什么牛逼的方法?考虑$$s$$到$$t$$的最短路DAG(也就是每条无向边拆成两条有向边，如果一条边在某条$$s$$到$$t$$的最短路上，那么它就在$$s$$到$$t$$的最短路DAG上)，我们可以跑出来每个点可以到哪些点，而这些点对就可以，别的就不行。这是最短路DAG的性质，也就是一条路是最短路，当且仅当它在最短路DAG上。

也就是说接下来我们要选择两个点$$x,y$$，满足最短路DAG上$$x$$可以到$$y$$，并且$$d(u,x)+d(y,v)$$最小。啊当然我们需要把$$x,y$$反过来再跑一遍。

这个怎么做?我们直接在最短路DAG上跑拓扑排序。做完了。

E. 毒蛇越狱

考虑这个东西能否用类似于法嘛塔的东西办了。感觉上不行，因为$$3^{20}$$足足有3e9，而法嘛塔总要把这些东西都塞进状态。

考虑能否强行逐位考虑?问题转化成维护一个集合，一开始是固定的1e6个数，每次删掉某一位是某个值的所有数，问最后所有数的和。这个听起来没法做。

吗?注意我们可以离线。考虑这相当于在一个$$3^{20}$$个状态的树上走，我们走过了的地方就不需要再走了，可以直接拿来用，这个可以直接在状态上一边走一边同时划分所有的查询来解决。考虑所有的查询最多可以经过多少个结点?显然是$$2^{20}\times 20$$的级别。考虑了一下，感觉上这个东西再怎么分析不会低于$$O(2^{(1+\epsilon)n})$$，于是还是别想了，不过要是在场上就先rush一发再说（

考虑能否折半之类的?这让我想起一个牛逼题，是21年二轮省集D6T2，然而这两个还是不是很像。我们考虑进行某种分治。

 - 如果查询中的?超过一半，那么我们就找到所有不是?的位置，同时对于原序列中每个数，枚举它保留一些位置，把剩下的位置换成?的方案，这样的方案一共有$$\binom{20}{10}=184576$$种。

 - 如果查询中的?不超过一半，我们枚举一个把这些?换成01的方式，同时对于原序列中每个数，枚举它把一些位置换成?的方案。

总复杂度$$O(2^n\binom{n}{n/2})$$。根据斯特林近似我们知道这玩意大概是$$O(n^{n/2}e^{-n/2}2^n)$$，它比$$O(3^n)$$要劣，并且实际表现也是这样，它的算量大概是1e11。

我们要做什么样的预处理，才能让回答询问的速度变得很快呢?

考虑另一种折半的方向，我们注意到$$3^{15}$$大约是1e7，于是考虑法嘛塔预处理前15位的结果(也就是忽略后5位)，它的算量是1e8级别，然后考虑如何加入剩下的5位。

我们需要新增一些限制，这样会有一些东西没掉。考虑是哪些东西，你发现回到了第一个想法/ll

完全不会了。考虑一个牛逼做法，我们强行把?当成1，然后跑子集前缀和。这样会有一些应该是1的位置被考虑成0，于是我们就完蛋了。考虑一个强做的办法，我们进行容斥，这样如果查询有$$c$$个1，复杂度就是$$2^c$$。于是我们找到01中较少的，一开始分别跑子集前缀和和子集后缀和，复杂度是$$O(2^nn+q2^{n/2})$$，可以获得75pts。

如何继续优化?考虑继续分治，如果?很少，我们直接搞?，复杂度变为$$O(2^nn+q2^{n/3})$$，可以通过。

我只能说太强了。这题强到没救。

-----

loj2413~2414 joi open 2017

没有A。

B. 推土机

考虑我们转转转，然后求一个最大子段和。这个转转转中，点之间的顺序只会改变$$n^2$$次，于是我们爆力搞出这些变化，每次是交换相邻的两个，线段树维护最大子段和即可。总复杂度$$O(n^2\log n)$$。

C. 高尔夫

球一定是砸在边界上，然后继续开出去。注意到只有4e5条线，每条线只可能往两边开球，于是一共只有$$O(n)$$个点和同阶的边，直接建图跑bfs即可。

但是有个大问题，我们怎么求出这些，也就是怎么求一条射线撞上的第一条线段?

扫描线线段树/扫描线set/分治。做完了。

-----

loj2724~2728 joi 2015 final

A. 铁路旅行

看了一眼感觉很困难，再看一眼发现是序列（

差分-前缀和一下算出每条铁路被经过多少次，然后看它是买票便宜还是买卡便宜就好了。

B. 分蛋糕2

直接复制一倍区间dp。

C. JOI公园

先从$$1$$跑dij，然后就可以知道打地道的范围要多大，一条边才会消失，做一个后缀加即可。然而这个范围最大可以达到1e10，我们需要对最短路离散化一下。

D. 舞会

草，为什么我会做到这个题，这是我初二的时候在bct见过的题，当时觉得非常牛逼（

每次留下中位数。

二分答案转01，然后我们让每个人表示，至少需要放多少个熟练度是1的人，才能让这个人的熟练度是1，最后看1的总数够不够即可。

E. 城墙

4e3/jy

直接做的复杂度是$$O(n^3)$$，这会飞掉。你说10s?sorry，肯定跑不过。

不过看起来复杂度是$$O(n^2\log n)$$或者$$O(n^{2.5})$$之类的东西。

考虑几种直接做的做法。本质上所有的爆力都是枚举了三条边，但是这里我们显然只能枚举两条，于是需要考虑枚举哪两条。

我们先枚举左边和右边，然后考虑这个正方形上下的位置。首先可以把左右边上有障碍的情况都删掉，这个怎么想都不超过4e8，随便跑了。问题变成两条横线上都不能有障碍的方案数。

讲道理，一条都不好做。诶一条好像是好做的，我们只需要从每个点出发强行往右延申就好了。

那么现在设一个格子延申的长度是$$f(i,j)$$，当前枚举的边长是$$l$$，我们就是要求左边$$x$$上有多少对$$i,j$$满足$$f(x,i)\geq l,f(x,j)\geq l$$之类的东西，可能还有一些$$\pm 1$$不过那不重要。

这玩意看起来像是法法塔吗?想了想你发现不行。fuck!换一个。

注意到，如果先枚举左边和下边，也就是先枚举左下角，那么剩下的两条边会形成了一个拐角的形状，而我们可以让它只剩下右上角一个变量。

我们让每个点强行往左、往下延申，看最多延伸到哪里，这个记为$$f$$。然后枚举左下角的时候，计算往右、往上最多延伸到哪里。那么可以画个图解释一下 : 

![img](/img/2021-12-18-loj-problems/2728.png)

然后你发现我们要求右上角那个点的$$f$$要比它到左下角的距离更大，这个大概是什么$$f(x+k,y+k)\geq k$$之类的，移一项就变成$$f(x+k,y+k)-\frac{1}{2}(x+y+2k)\geq-\frac{1}{2}(x+y)$$之类的(当然是固定了斜线所以可以随便移项)，然后就变成在一条斜线的区间上查询比某个数大的数的个数，这完全是二维数点，扫描线BiT即可。

这个题告诉我们两个道理，一个是只要你能枚举所有的扫描线方向，肯定可以做出来；另一个是能快速减少变量数量的扫描线方向直觉上看起来会更优。

-----

loj2741~2743 joi open 2016

A. JOIRIS

所有的块都是一样的，这就看起来比较离谱。

简单想法是，我们直接模拟。考虑找到最左边的最低的位置，然后它必须塞上一个什么东西，那么我们就给它塞点什么东西上去。如果能放横着的那就放横着的，否则放竖着的。

你发现这个不行，它过不了第一个样例。离谱¿

不会了。看题解。但是这个题解好难找（

另外第一个样例也告诉我们，消除是有用的，我们不一定总是从上往下消。

先考虑点性质。把列按膜$$k$$分成若干等价类，每个等价类高度都加起来，那么横着放会让所有等价类$$+1$$，竖着放让一个等价类$$+k$$。最后前$$n\bmod{k}$$个等价类相同，后面$$k-n\bmod{k}$$个等价类相同，所以一开始也必须满足这两个性质。

还有啥性质?不知道。想不出来了。

那么我们强行构造。

首先考虑，我们塞竖着的不会改变有没有解。所以我们可以强行塞竖着的，把它变成单增的。

接下来，我们尽可能塞横着的(即使塞了会不满足单调)，从而把$$k$$列和右边的全部推平到同一高度。然后尽可能塞竖着的，从而把$$k$$列和右边的全部清空。现在只剩下左边$$k-1$$列。

考虑现在前$$n\bmod{k}$$列膜$$k$$是一样的，接下来的$$k-n\bmod{k}$$列膜$$k$$是一样的。注意到$$k$$列清空了，所以$$n\bmod{k}+1$$到$$k-1$$列实际上也全是$$0$$。我们把前面$$n\bmod{k}$$列补齐，然后不停往右边放横着的，就可以清空了。

这个题的做法其实很直接，只是有些时候我不敢想这种强行的做法，其核心就是不断尝试简化问题。

B. 销售基因链

简单题。有一个线性做法，可以在 Sxy\_Limit的博客 https://www.cnblogs.com/Sxy_Limit/p/12930980.html 看到。

C. 摩天大楼

好像是经典题，但是我没做过（

复杂度像是$$n^2v$$或者$$n^3+v^2$$之类的。

扫序列毫无前途，我们扫值域。考虑最大的那个数，它的贡献一定是正的。

考虑次大的数，它的贡献几乎是正的，除非它和最大的挨着，那么它会贡献一次负的。第三大的数，如果挨着最大的和次大中的两个，那么会贡献两次负的，挨着一个则贡献一次负的，不挨着则都贡献正的。

我们怎么描述 和更大的数挨着 这种事情呢?我们可以在旁边两个位置上留一手接头，表示放在这两个位置会贡献一次负的，如果一个位置被标记两次那就是贡献两次负的。不妨把它们称作1接头和2接头。

考虑我们怎么才能记录两类接头的数量。你发现不能，因为位置会影响数量的变化。遇到了僵局。

不要考虑数量的变化，我们钦点这些接头!也就是说放进一个数去，直接钦点它左边和右边的接头在被消除的时候是1还是2，如果是2那就需要留一手，让后面一个数来把它变成2，留一手这类接头我们称为1.5。接下来我们记录有多少个1/1.5/2接头即可。然而还是有问题，我们如果要把左右两个1都变成2，可能实际上没有位置可以做这件事，这就很难受。

这个思路完全失败了。还有什么?

可以考虑插入而不是摆放。

此时扫值域的优势完全体现了出来，我们插入一个数，两边的数都比它大，设这三个数分别是$$a,x,b$$，那么贡献会增加$$2(\min(a,b)-x)$$。考虑我们把这个拆开，每次插入之后直接把$$2(\min(a,x)+\min(x,b))=4x$$扔进总和，$$-2x$$在插入的时候加进去，这样。同时维护所有空位多加了的东西，也就是所有间隔的$$\min(a,b)$$之和，最后减去即可。

你发现这个多加了的东西没法维护，因为我们插入的时候，需要知道这个间隔原来的$$\min(a,b)$$，这就完蛋了。

怎么才能把这个去掉?考虑我们在插入的时候，钦点新产生的空位以后还会不会被插入，也就是多记一个还有多少没被钦点没了的空位，转移的时候我们只往这种空位里面放，最后所有的空位都被钦点了，那就对了。

设$$dp(i,j,0/1/2,k)$$表示考虑前$$i$$个数，有$$j$$个中间的空位没被钦点，$$0/1/2$$个边上的空位没被钦点，当前总和是$$k$$。转移就是考虑插到中间还是边上，然后新产生的空位是否要钦点。写一发你发现对了，OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO!但是这个的状态数是$$O(n^3v)$$，转移是$$O(1)$$，过不了。

考虑对第三维优化掉一个$$n$$，我们需要某种方法使得统计和的时候不会有负的，这样就可以利用$$L\leq 1000$$了。考虑我们这个东西实际上是一个线头dp，我们留接头的时候，可以一边扫一边加上这一步的长度乘上线头的个数，而不是进行差分。这就做完了。如果要直观描述这一做法的话，就是把这个排列想象成折线，然后从上往下扫，记录扫描线上方的长度和接头的个数。

$$O(n^3v)$$的做法可以在 https://loj.ac/s/1328392 看到，$$O(n^2v)$$可以在 https://loj.ac/s/1328415 看到。

这个题告诉我们，只要你能枚举出所有的扫描线方向和所有的转移结构，什么题都可以做出来，所以做数数题一定要充分自信，敢于硬想。另外就是，我们可以钦点产生的接头类型，从而使用线头dp来rush。

-----

loj2756~2760 joi 2014 final

A. JOI徽章

模拟。

B. IOI馒头

背包。

C. 年轮蛋糕

最小值最大，先二分再说。诶这种$$n^2$$个数二分的题是否有什么把$$\log v$$变成$$\log n$$的技术啊（

然后我们要让每一块大小都比二分的数要大。这个怎么做?我们先枚举第一刀切在哪，于是贪心地，接下来每一刀都希望切的尽可能近一点，于是我们双指针扫一遍求出来最近切到哪，然后直接看有没有一个位置可以切一圈就好了。

D. 飞天鼠

看起来这是一个最短路问题。直接做，状态数是$$nv$$级别的，这就很不好，于是我们希望缩减状态数。

首先一个显然的结论是，如果确定了一条路线，那么我们除非迫不得已，否则不会爬树。也就是说，我们会一直下降直到不能继续下降，然后就相当于在这个点从$$0$$开始了。

于是我们把这个过程分成了三段，第一段求第一棵树只使用下降到达每棵树的最小时间(此时高度必然最大)，第二段求每棵树用恰好的升高走到相邻的一棵树，把高度变成$$0$$的最小时间，第三段求每棵树的高度$$0$$处走到最后一棵树的最小时间。做完了。

E. 裁剪线

为什么joi这么喜欢计算几何（

这个问题是求平面被划分成了多少区域。这让我们想起什么?欧拉公式。扫描线线段树即可。

另一个想法是扫描线的过程中维护连通性。我们从左往右扫，如果扫到了一个横的起点那就进行分裂，横线的终点就进行合并，扫到竖线那就切断一个区间和后面的联系。总之就是很复杂。

-----

loj2761~2765 joi 2013 final

A. 彩灯

考虑枚举是奇数位黑色还是偶数位黑色，然后问题变得显然了。

B. 搭乘IOI火车

题意是，两个01序列，分别找一个区间，使得它们可以归并成0101010101010101这样的，最大化归并出来的长度。

这玩意居然让我一时不会做了（

考虑dp，设$$dp(i,j,0/1)$$表示第一个左端点选$$i$$，第二个选$$j$$，第一个字符是$$0/1$$，最多能搞出多长，转移显然。

C. 现代豪宅

考虑建两层图，分别表示按了奇数次和偶数次之后的情况，只往图里加特殊点，每个点只会贡献两条边，于是总边数就是对的。

D. JOIOI塔

实际上是说能找出多少个不交的JOI或者IOI子序列。

考虑网络流，众所周知hlpp可以跑1e6!

想了想你发现不能网络流（

你发现问题出在，我们不知道一个I应该贡献给第一个字母还是第三个字母。

二分答案，这样我们尽可能在右边凑出足够的OI，然后就不再需要OI了。

线性做法也很简单。我们考虑一定是一个前缀的I贡献在第一个位置，剩下的那个后缀的I贡献在第二个位置，于是我们对每个前缀尽可能匹配JO,IO,J,I这样的，对后缀匹配JOI,OI,I，然后枚举中间的分段点来合并即可。代码可以在 https://loj.ac/s/1328750 看到。有别的牛逼线性老哥跑的比我还快?

E. 冒泡排序

惊悚题目名（

同时是loj round #6 C. 花火。

然而是关于逆序对数的问题。做一次交换最小化逆序对数的话，考虑如果我们交换$$a_i,a_j(i<j,a_i>a_j)$$，会发生什么变化。呃为什么$$a_i>a_j$$?交换顺序对显然是不优的啊（

对于不包含$$i,j$$中任何一个的对，显然没有变化。对于$$i$$前面或者$$j$$后面的某个$$k$$，跟$$i,j$$中的某一个组成的对，也没有变化。

那么也就是只有区间$$[i+1,j-1]$$中的某一个东西和$$i,j$$中的某一个组成的对会产生影响了。如果一个位置$$k$$满足$$i<k<j$$且$$a_i>a_k>a_j$$，交换$$i,j$$会让包含$$k$$的逆序对减少两对。如果$$a_i>a_k=a_j$$或者$$a_i=a_k>a_j$$，那么只会减少一对。

$$i<k<j$$且$$a_i>a_k>a_j$$，这个描述了一个矩形$$[i+1,j-1]\times[a_j+1,a_i-1]$$。于是我们现在可以$$n^2$$用二维前缀和做这个。

考虑我们应该怎么选取扫描线方向。显然的想法是扫$$k$$，但是扫了$$k$$之后变成了四维的，这就很难受。

差分。这个相当于是$$[1,j-1]\times[1,a_i-1]-[1,i]\times[1,a_i-1]-[1,j-1]\times[1,a_j]+[1,i]\times[1,a_j]$$。现在每个问题是四个二维的和，于是我们就让每个贡献贡献给这四个问题即可。做完了。

吗?这个还是四维的/cy

所以怎么办呢，看起来我们必须找一点性质。考虑什么样的$$i$$一定是不优的，你发现如果有一个$$i^\prime$$使得$$i^\prime<i,a_{i^\prime}>a_i$$，那么$$i^\prime$$比$$i$$更优。所以说我们单调栈筛出所有前缀$$\max$$，它们是所有可能的$$i$$，而显然后缀$$\min$$是可能的$$j$$。

考虑单调性有啥用。你发现以前一个$$k$$贡献的是所有$$i<k<j$$且$$a_i>a_k>a_j$$的，现在$$i$$们和$$j$$们的$$a$$都单增了，所以$$a_i>a_k$$的$$i$$是一个后缀，$$a_k>a_j$$的$$j$$是一个前缀，于是每个$$k$$贡献一段区间，这就变成二维的了。扫描线线段树即可，复杂度是$$O(n\log n)$$。

一个更见鬼的方法是分治。从小到大枚举$$i$$，对应的最优的$$j$$是决策单调的，于是分治即可。需要数据结构支持数点，所以会多一个$$\log$$。

-----

loj3010~3014 joi 2019 final

A. 勇者比太郎

看起来就是一个拐。考虑我们扫什么，你发现不管扫什么都可以，当然简单做法还是枚举$$i,j$$，预处理$$k,l$$($$k,l$$是独立的)。

B. 这看起来至少是一个二维lis。

呃等等，lis个锤子，这是无序的/jy，我对着lis想半天（

考虑直接贪，同时从大到小扫框和画，找到可以放进来的画中美观度最大的即可。

C. 有趣的家庭菜园3

只有400/jy

交换相邻/jy

问题是求重排成没有相邻的之后，最小的逆序对数。显然我们重排之后，对于所有的R，一定是按原序列中的顺序排的，GY是一样的。

考虑直接dp最后的序列。我们记录现在用了多少RGY，然后要计算逆序对数的话，也就是每在最后插入一个，需要知道前面有多少比它大。设$$dp(i,j,k,0/1/2)$$表示放了$$i$$个，其中RGY分别$$j,k,i-j-k$$个，最后一个是$$0/1/2$$的方案数，转移枚举下一个放哪。假设放R，那么可以随便求出这是原序列中第几个R，这个设为$$x$$，则逆序对数要加上前面比$$x$$靠后的数量，也就是$$x$$到第$$k$$个G之间有多少G这样的问题之类的，随便做就行了。

D. 硬币收藏

问题是找到一个$$(1\leq x\leq n,1\leq y\leq 2)$$的排列$$(a_i,b_i)$$，最小化$$\sum\vert a_i-x_i\vert+\sum\vert b_i-y_i\vert$$这样的。

注意到每一个硬币总要进入$$[1,n]\times [1,2]$$这个矩形，所以可以先把所有点移动到这个矩形中离它最近的点。因为是矩形，这样做一定不劣。

然后问题是我们需要把这些硬币移动到正确的位置去。讲道理这是不是很经典（

但是我写了两发假贪心都挂了/fn

考虑一个真贪心，我们从左往右扫，维护两行各有多少多余的棋子，这个可以是负的，表示有多出来的空位。然后讨论一下就行了。

这个题大概是告诉我们，处理这种移来移去的问题，可以把空位留到后面进行决策，这可能会把问题变得显然。

但是是不是有无脑强力做法呢?不知道。

E. 独特的城市

看起来这个说的是，对于每个$$u$$，把所有点到$$u$$的距离拿出来，对独特的点求一个颜色数。

草，怎么是树啊（

考虑这个独特的点的集合说的是什么。我们以$$u$$为根把树拎起来，那么如果一个深度只有一个点，它就是独特的，这是显然的。

先考虑颜色互不相同怎么做。

考虑分治?感觉上不好合并，因为以每个点为根的时候这些深度是不一样的。

考虑这玩意有没有什么牛逼性质，比如直接换根什么的?想了想，从父亲走到儿子是子树深度$$-1$$，子树外深度$$+1$$，于是干脆变成子树$$-2$$。也就是说，我们需要支持子树$$\pm 1$$，查询有多少个独一无二的值。

注意到一个子树的深度是连续的，所以我们可以直接随手维护，每次只有两边会发生变化。然后只需要开个桶维护这些点就行了。

但是怎么知道这些点是哪些点?考虑以$$u$$为根的时候，只有$$u$$开头的长链上可能有独特的点，而长链的另一端一定是某个直径端点，于是跑两遍，分别处理到两个直径端点的路径即可，呃这么说可能有点奇怪，就是从两个直径端点出发换根。复杂度线性。

-----

loj3153~3155 joi open 2019

A. 三级跳

查询区间中所有满足$$i<j<k,j-i<k-j$$的$$a_i+a_j+a_k$$最大值。

5e5 4s，考虑啥呢?

subtask3怎么做?枚举一个$$j$$之后，变成了$$2j<i+k$$，看起来是个$$\max,+$$卷积。枚举另外两个看起来是一样的。咋回事呢?

呃这不是$$\max,+$$卷积，这是$$\max,+$$卷积的后缀$$\max$$。算这个是不是经典问题?

好像不是。完蛋了。

考虑有没有什么性质。这个题看起来还略微有点像是那个 区间最小$$\vert a_i-a_j\vert$$之类的。经过一些筛选之后，也就是说我们拿一些必要条件来约束之后，可能的三元组可能会变得很少。

为了支持区间查询，我们在构造约束的时候，一定是构造$$i^\prime,j^\prime,k^\prime$$使得$$a_{i^\prime}+a_{j^\prime}+a_{k^\prime}\geq a_i+a_j+a_k$$，且$$i\leq i^\prime,k^\prime\leq k$$。考虑第一段可以缩短，但是第二段不能缩短，于是我们可以想到，如果$$i,j$$不是区间$$[i,j]$$的最大值和次大值，那么选取实际的最大值和次大值必然更优。

于是考虑 两个端点分别是区间最大值和次大值 的区间有多少个。你发现这居然只有$$O(n)$$个，因为考虑了几下你发现我们可以在一个区间的次大值那个端点处统计它，这就结束了。

呃怎么结束了?扫描线扫就是了。

B. 汇款

枣枣枣之言可谓切中了肯綮。注意到这个类似于进位，问题在于最高位可以进给最低位。这怎么办呢?

我们当作没有这样的进位，然后可以求出这两个数的差，那么根据这个差可以求出从最高位到最低位进位的量(每次进位会减少$$2^{n-1}-1$$)，于是就破环成链了。

呃这个差可能非常大，怎么办?牛迭法法塔（不是

考虑这个除法有啥性质，它相当于每次拿出最高位来$$-1$$，然后让最高位后面第$$n$$位$$+1$$，于是我们只需要直接这么做即可，这是经典问题。

兔的题解是带状高消，看起来并不是非常本质相同（

C. 病毒实验

这个题好像非常经典，但是我没做过（

800 1s，好像想不到什么。

考虑一个很经典的事情，如果我们点了A之后，A会感染B，那么我们直接点B一定不劣。于是模拟出每个人第一个感染的人，这会形成一个DAG，DAG上每个SCC的答案是一样的，只有没有出度的SCC才有可能有贡献。

如果是求最大的话已经做完了，因为那样就是直接点B一定不优，于是每个点只会搜一次。这就出到模拟赛里/jy

这个 没有出度的SCC 可能有多少个?如果它很少我们就赢麻了。

然而它实在是可能很多，构造方法是用一些0来把人们分开。这就完蛋了。

还是考虑怎么快速模拟。注意到一个人会不会被感染，只跟周围四个人有关，而我们可以爆力求出周围四个人在哪些情况下会让这个人被感染，也就是进行16遍模拟，每次模拟两轮，求出一个情况能感染掉的最大抵抗力。

于是现在我们进行强力模拟，每次让一个人被感染，就判断他周围四个人，这样复杂度是$$O(n^2)$$。还需要枚举人，于是这玩意不可能过。

考虑一个牛逼做法，我们对每个人，模拟前100个感染的人，他感染到的这些人都不比他劣。然后再跑那个SCC，此时没有出度的SCC个数将会非常少。

能不能估计一个数量呢（

看起来这个数量不可能超过$$\frac{rc}{100}$$，因为每个没有出度的SCC至少需要100个点。

这让我们发现了一些有趣的事情。考虑类似boruvka的做法，我们先找到每个人A感染的随便一个人B，然后将A合并到B这样的，现在问题是每个集合有一个最优的人，怎么快速选择这个人之后，在这个集合之外感染的第一个人。

我们对于每个集合，求出选择它里面最优的人之后，这个集合会被怎么感染，合并的时候直接重构复杂度就是对的。然后在集合边界上枚举即可。复杂度$$O(n^2\log n+m)$$。

-----

loj3252~3256 joi 2020 final

近代joi了（

A. 只不过是长的领带

二分答案，然后每个人有一个可以戴的区间，我们的任务是ban掉每一个，然后得到一个完美匹配。定长分块优化建图，跑一个dinic，然后强行退流并再次增广，复杂度飞了。

太离谱了。考虑能不能直接贪心而不是dinic，你发现可以。

考虑能不能批量做这个贪心，你发现还是可以，正着一遍倒着一遍就行了，因为区间都是等长的。做完了。

诶是不是不需要二分?好像是的（

B. JJOOII 2

相当于找到一个最短的子串，使得它包含一个k级joi串。

考虑这个咋做，我们枚举第一个位置，然后往后在子序列自动机上跳就行了。现在问题是怎么才能快速跳$$k$$次，开vector即可。

C. 集邮比赛 3

走到的肯定是一个区间，区间dp。

D. 奥运公交

边数很大，我们需要缩小枚举量。

显然翻转的这条边，翻转之后会改变$$1$$到$$n$$的最短路或者$$n$$到$$1$$的最短路。注意这两个是可能都改变了的（

考虑这样的边能有多少以及怎么求，你发现数量会很大，但是一个最短路树就都搞定了。具体一点就是，我们可以借助最短路树$$O(n)$$算出一条边翻转之后新的最短路，于是枚举即可。

E. 火灾

数据结构题/hanx

考虑subtask2怎么做，你发现只需要求出每个位置影响到哪里就好了。

然后你发现每一个位置会一直往后影响到后面第一个比它大的。我们只需要求出来影响了多长，然后覆盖一下。

考虑subtask3怎么做。我们查询一个时刻的时候，考虑它前面所有能延伸到它这里的，也就是从它往前看的所有后缀$$\max$$，这个确实是单调栈的工作。我们可以在单调栈上二分现在是哪个覆盖过来了。

区间查询的话，我们先差分变成前缀查询。

注意到每一个连续段有四种可能 : 

 - 左边不动，右边伸长

 - 左边缩短，右边伸长

 - 左边缩短，右边不动

 - 消失了

每一段都会经历这四个过程，当然其中有的过程可能持续了0时刻。可以一边扫一边用set维护每一段。

于是查询的时候直接做即可。这看起来还是很复杂，但是反正我只是在胡（

-----

loj3361~3363 joi open 2020

joi的官方题解好像需要梯子才能看到/yun，可以在QingyuOJ(qoj.ac)上找到这一场的题解，其中B还是非常有趣的。

A. 家具摆放

这是一个非常经典的问题，原题是 XXI Open Cup, GP of Korea B. Cactus Competetion。

结论是，能走过去，当且仅当没有一行没了，没有一列没了，没有一个拐挡住了起点，没有一个拐挡住了终点。容易归纳证明充分性，但是问题是，谁会想到这个题需要拿必要凑充要呢?

剩下的问题是拐怎么维护。想了想感觉居然有点困难/jy

考虑插入一个新的1，要想找到一个拐，首先这个拐得经过这个1，于是数量变成了$$O(n)$$。但是1e9过不去（

我们维护每一行和每一列的极长前缀1，这个可以BiT搞定。然后分别考虑拐的顶点在新的1所在的行和列上的情况。以行上为例，我们维护了每一列的极长前缀1，只需要查询这一行的极长前缀1范围内，各列极长前缀1是否有足够长的，也就是求一个最长的，这个可以用BiT维护，需要支持撤销一步。总复杂度$$O(q\log n)$$。

B. 黑白点

这玩意看起来很像csp2021 D 交通规划（

然而还是不太一样，因为这个趋向于往外走。

考虑这个有点像AGC018D，但是又完全不像。

这里先讲一个类似于AGC018D的思路。考虑一条线段$$(i,j)$$，它上面的交点个数不会超过它两边点数的较小值。如果我们可以让所有的交点个数都取到这个较小值，那么就必然最优了。

考虑什么情况下可以取到。不妨假设$$i$$是白色，$$j$$是黑色，$$i<j$$，并且$$i$$到$$j$$是短弧。那么对于$$i<k<j$$，考虑钦点如果$$k$$是白色则连到比$$i$$小的位置，如果是黑色连到比$$j$$大的位置，也就是说我们连的是递增的，或者说把黑点们任意循环移位之后(当然移白点是一样的)，第$$i$$个白点连第$$i$$个黑点。

后面就和后面一样了。

这是一开始的想法。

交点有啥性质?不知道。

考虑啥时候会出交点，我们知道如果两对$$(i,j),(k,l)$$满足$$i<k<j<l$$或者$$k<i<j<l$$就会出交点。也就是说，我们需要找一种配对方案，使得每一对都满足$$s_i=s_j$$，并且满足$$i<k<j<l$$的两对数最大。

先想一个多项式做法。

注意到如果有两对满足$$i<j<k<l$$的$$(i,j),(k,l)$$，那么我们可以调整一下变成$$(i,k),(j,l)$$，这样本来跟它俩中的两个相交的，现在还是跟两个相交；本来跟一个相交的，现在还是跟一个相交；本来不相交的，现在还是不相交，或者可能变得相交两个。但是这样的调整可能是不可行的，因为可能$$i,k$$是白色而$$j,l$$是黑色这样的，换了配对就会出问题。

然后就不会了。看看题解，好离谱（

考虑根据上面这个结论可以知道，最优策略一定是把所有黑点和白点的位置分别找出来，任意破环为链之后，第$$i$$个黑点匹配第$$i$$个白点。上面的结论其实是说明逆序对一定不优。

然后我们就会$$n^2$$了，考虑怎么进一步优化。

考虑一个牛逼结论，在这个构造中，跨过一条线段的边数，恰好是两边点数的较小值。这是显然的。

然后呢?设白点序列是$$a_i$$，黑点序列是$$b_i$$，那么我们就枚举$$k$$，钦点$$a_i$$匹配$$b_{i+k}$$即可。最后答案看起来像是

$$
\max_k\sum_{i=1}^n\min\big((b_{i+k}-a_i-1)\bmod{2n},(a_i-b_{i+k}-1)\bmod{2n}\big)
$$

这个$$\min$$上会发生若干次切换，当然每个$$i$$只会切换最多两次。

考虑一个$$a_i$$对每个$$k$$的贡献，它在一些位置贡献$$-a_i-1$$，一些位置贡献$$a_i-1$$，一些位置贡献$$-a_i-1+2n$$，一些位置贡献$$a_i-1+2n$$。

考虑一个$$b_i$$对每个$$k$$的贡献，它在一些位置贡献$$b_i$$，一些位置贡献$$-b_i$$。

然后就做完了，维护三个指针硬扫，复杂度是线性。

C. 发电站

感觉上是说，如果一条链的端点都被打开了，那么中间就都会损坏。

注意到我们几乎不可能让一个发电机坏掉，除非它确实需要坏，比如在菊花中，中间那个必须坏掉，这样我们可以选择所有的叶子。

注意到有的基站没有发电机，这说明我们可能选择一条长链。

我们可以取消选择所有不爆的，于是可以考虑选的时候就让它不会爆。

强行树形dp。考虑如果一个点选了，要么它子树外都不选，要么它子树内都不选；如果一个点没选，那么它的各个子树都可以选，子树外也可以选。设$$dp(u)$$表示在$$u$$子树外还能选的前提下，$$u$$子树内的最大收益，于是它应该和$$a_u$$取一个$$\max$$，表示只选自己，这里$$a$$当然表示发电机数量。考虑转移，那就是直接把每个子树加进来，最后减去$$a_u$$。

然后考虑在每个方案的lca处统计答案。

 - 如果lca选了，那么lca只有一个子树可以选，我们必然取最大的子树

 - 如果lca不选，那么每个子树可以自由选择选或者不选

强行转移即可。然而这个题想了半天，看了题解一眼是dp才想到要强行dp，我还是naive了/ll

当简单方法都解决不了了，再去发现性质，并且每发现一个性质，都应该回去再看一遍所有的简单方法。我觉得我这话说的很好。

-----

loj3468~3472 joi 2021 final

A. 有趣的家庭菜园 4

看起来就是严格单峰的。

呃直接从两边往中间模拟即可。

B. 雪球

因为所有雪球都是一起移动的，所以如果一个雪球走到了别的雪球走过的地方，那么它往回走才可能继续走到雪上。

考虑我们对每个雪球求出它第一次走到左右雪球的轨迹上的时间，这个可以直接二分得到。做完了。

呃注意到这是对于一个序列的多次二分，于是或许可以用什么技巧优化到线性/yiw，不过我也懒得想了（

C. 集体照

只有5e3。是不是随手啊!

注意到高度是排列，所以如果有问题，那么只能是相邻的两个人，一个高$$x$$，一个高$$x-1$$。于是整个序列划分成了若干个下降的连续段。只需要按值域扫描线，设$$dp(i)$$表示放了前$$i$$个人，他们是$$[1,i]$$的最小逆序对数，转移就是枚举$$i$$所在的下降连续段，然后因为这是每次加入一个，容易二维前缀和计算贡献，至少感觉上是这样的。

D. 机器人

除非不连通，否则不可能无解。

考虑首先我们肯定不会一个点走两次，所以只需要把走一条边的代价赋成把它的颜色改成独一无二的代价。注意到走的每条边，要么是原来的颜色(把同色的都改掉)，要么是改成同色权值和最小的颜色(然后把同色的都改掉)，要么是改成次小的(因为有两条边，这两条边颜色也要不同)。

于是把每个点拆成三个点，表示入边是原来的颜色，最小的颜色和次小的颜色即可。

不过这个东西假了，因为如果入边是原来的颜色，我们选择了一条和入边颜色相同的出边就不好处理了，因为此时我们并不能让 把别的同色的改掉 这件事变得容易描述。

考虑一个牛逼做法，我们给每个点建度数个虚点，表示进来的颜色，于是就结束了。

E. 地牢 3

又是数据结构题/se

这让我们想起一个经典题叫Organizing a Race，但是这俩还是完全不一样。

爆力怎么做，爆力是不是，直接最短路!(呃当然这个最短路实际上是dp)

贪心地，我们只可能做两种购买，恰好撑到下一次买，或者买满。于是现在每次查询只有$$O(n)$$状态数了(每个只会贡献一个状态)，双指针扫一扫建立状态，单调队列优化转移，复杂度是$$O(nm)$$。

然后呢?你发现给$$O(nm)$$的subtask1只有11pts，我们的做法是不是过于复杂了（

考虑加强这个结论。容易想到，考虑在$$i$$买一次，能走到的区间设为$$[i+1,j]$$，考虑这个区间中第一个满足$$b_k\leq b_i$$的$$k$$

 - 我们肯定希望加到恰好能走到$$k$$，因为这样一定不劣。

 - 如果不存在这样的$$k$$，那么我们会加满，然后走到$$[i+1,j]$$中最小的。

这个策略感觉上很对，于是我们现在可以知道每个位置有一个$$\mathrm{next}$$。然后就是经典做法，这个$$\mathrm{next}$$构成一棵树。

在$$u$$上扫描线，然后用类似 弹飞绵羊 的方法来维护，每块开一个lct，超出块的直接查，复杂度$$O(n\sqrt{n\log n})$$。

考虑$$\mathrm{next}$$的切换只会发生$$O(n)$$次，这是因为$$\mathrm{next}(i)$$的取值就是从右往左单调栈的时候$$i$$弹掉的所有元素和$$i$$之后的第一个元素。除了$$i$$之后的第一个，别的都弹掉了，于是总切换数就是$$O(n)$$。整个用一个lct来维护即可，或者如果你想，也可以根号重构什么的来降低现场的代码难度（

-----

loj3520~3522 joi open 2021

A. 杂交

先考虑只有一次询问怎么做。

考虑构造一个什么结构满足J+J=J,O+O=O,I+I=I,J+O=I,O+I=J,I+J=O。

你发现这个结构性质不好，因为打表可以发现它不是结合的，简单的反例是(J+J)+O=I，而J+(J+O)=O。没有结合律意味着很多事情都不能做，比如它不可能和一个我们熟悉的结构同构。

能不能强行考虑?考虑三个串可以生成什么样的串，这可以随三个然后搜一搜。我搜了一个长5的，用xorshift64生成。

```
01211
12000
22212

20122
10210
02121
11120
21002
00001
```

看起来很有趣......呃啥也看不出来。

换个种子试试。

```
00000
02022
11220

01011
22110
20121
12201
21102
10212
```

呃为什么还是六个?换个长度试试。

```
0000002022
1122022200
1110021000

2211012111
2220010011
1101020100
0021001122
0012000222
2202011211
```

草，离奇了（

一共只有九个串。用线段树维护一下对于每一个串，区间不对的个数就彳亍了。

B. 决算报告

一眼没看出A的我 : 没想到吧，这才是签到题（

直接dp即可。

呃这可吗?好像不可。

哦这是可的。考虑设$$dp(i)$$表示以$$i$$结尾，并且$$i$$作为最后一个前缀$$\max$$的最大得分，转移的时候，如果要从$$j$$转移过来，那么要求$$j$$到$$i$$之间没有一段长$$d$$的比$$a_i$$大的数。先扫值域预处理这个东西，然后直接线段树优化转移即可，复杂度$$O(n\log n)$$。

C. 怪兽游戏

1e3个数，1e4次调用，看起来很紧啊，于是我们确实需要紧的排序。

先想点性质。

有两个想法。第一个是考虑直接按照这个排序之后会出什么问题。你发现它会分成若干段连续下降的，而这些段之间看起来是上升的。

第二个是直接考虑一个方法。你发现常见的排序中，只可能是拿归并/二分插排/选择来做，但是考虑了一下二分插排肯定没前途，选择要开数据结构也没前途(因为数据结构比归并复杂?)，所以考虑归并。

但是你发现归并是归并不了的，因为如果我们遇到了不对的那就完蛋了（

于是先考虑第一个想法。我们先进行一次归并排序，实现的时候注意一点，就可以达到9e3次询问以内，于是我们还有1e3次多可以用。随一些试一试，你发现排出来的确实满足我们一开始考虑的性质。注意最终的序列也可以看成随机的，因为我们一开始可以把它随机打乱，这样spj应该很难卡出奇怪的边界情况?

考虑接下来怎么用$$O(n)$$次找到这些反着的段，接下来我们只需要把它们全都翻转就好了。我们只需要找到所有两边的数不在同一段的间隔。

先注意到一个性质，排序之后必然不存在相邻的两个长$$1$$的段，或者说相邻两段的开头差不可能是$$1$$，这可以随一随验证。呃更强一点的结论是，排序之后相邻两个总是满足题目给的顺序。

考虑我们现在处理了前面若干段，设上一段是$$[l,r]$$，于是下一个要么是$$l-1$$，要么是$$r+1$$。

如果$$l=r$$，那么我们只需要拿$$l$$和这个问一次，答案是反着的。

如果$$r-l+1\geq 3$$，那么我们只需要拿$$(l,r)$$内任何一个问一次，答案是正着的。

如果$$r-l+1=2$$，那么我们拿$$l,r$$问得不到任何信息，因为不管其实是什么，答案都是一样的。/fn/fn/fn

那怎么办呢?考虑换一个扫描线方向。

-----

loj3538~3541 joi open 2018

A. 冒泡排序2

冒泡排序轮数显然是经典结论，但是我不知道的话还能怎么办呢（

考虑如果只问一次怎么做。那也不会/fn

考虑冒泡排序是找到一个很大的，把它往后放，直到撞到一个更大的，就换成这个更大的往后放。

B. 猫或狗

C. 山体滑坡

D. 木琴

怎么感觉又是倒序的（

极差让人想到笛卡尔树之类的东西。但是那个还是太复杂。

用$$p_i$$表示数$$i$$的位置。注意到给了一个牛逼性质，也就是$$p_1<p_n$$。这玩意有啥用?

考虑我们找到$$p_1$$。你发现这个只需要从右往左二分就行了。

然后我们从$$1$$出发往左右扫，