---
layout: post
title: 一轮省集
subtitle: /kk
tags: 题选做
---

## Day1

### 模拟赛

兔队(clz,PinkRabbit)搬题。

T1 permutation

XXI Opencup, GP of Tokyo, Problem. I

CF Gym 102978I

给一个长$$m$$，值域$$[1,n]$$的串$$x$$，计数有多少个长$$n$$的排列以这个串作为字典序最小的长$$m$$的子序列。$$n,m\leq 2.5\times 10^5$$，膜$$998244353$$。

两个特殊性质部分分，分别是$$x$$单增和$$x_2=1$$。

先考虑第二个部分分。什么时候不能选$$x_1=1$$作为字典序最小的子序列?当$$1$$后面不足$$m-1$$个数的时候。而$$x_2=1$$，这说明$$1$$一定在$$n-m+1$$这个位置上，而剩下的部分一定紧凑地排在后面。

所以，我们考虑$$x_1$$的位置，它可能在前面任何一个位置，进一步你发现前面是全排列。但是如果前面有比$$x_1$$小的，那么不可能取到$$x_1$$，我们特判一下输出$$0$$。

然后考虑第一个部分分。考虑把不在这个子序列里面的数插入进去。打表你发现此时每个数可以插入的空位是一个前缀，并且随着数的增大这个前缀变长，具体怎么样可以自己观察。这样我们的决策就没有后效性了，所以我们直接从小到大乘起来就好了。

正解考虑把这两个结合起来。(然而我都打出来了，没想到正解)

考虑第一个$$x_i>x_{i+1}$$。此时一定是$$x_{i+1}$$因为后面的数太少了之前没法取，可以类似第二个部分分得到它和后面的数位置已经确定。此时前面的数就是第一档部分分了。复杂度$$O(n)$$。

T2 game

2020-2021 ACM-ICPC, Asia Nanjing Regional Contest, Problem. M

CF Gym 102992J

背景是一个Nim，这里只说转化后的问题。

维护一个序列，支持区间对一个数取$$\max$$，查询区间异或和，或者区间中有多少个数在第$$k$$位上是$$1$$。$$n,m\leq 2\times 10^5$$。

考虑吉老师线段树。做完了。复杂度$$O(n\log n\log v)$$。

当场写完!结果修改写错了（

T3 skate

XIX Open Cup, GP of Korea, Problem B

CF Gym 102059B

有一个$$n\times m$$的滑冰场，场上每个格子可能是空地或者障碍。

你的移动方式是，选择上下左右中的一个方向，然后向那个方向滑过去，直到到达边界或者撞到障碍才停下。

你从一个空地出发，需要经过一些标记点(滑过去也算经过)。问有没有可能经过所有标记点。$$n,m\leq 50$$，$$5$$组数据。

考虑一个经典做法，我们对于每个位置，求出它所在的极长的横着和竖着的段。显然有如果你在一个极长段的任意一个位置停住了，你接下来都可以走遍这个段。同时，一个标记点被走到了，当且仅当它所在的横着的段和竖着的段至少一个被走到了。

你看到了一个2-SAT!

然后问题就是怎么在2-SAT上描述各种限制，从而充要地得到一条路径。

实际上只需要表示两个段不能互相到达，此时选了一个不能选另一个。为什么满足这个限制就等价于有解?

首先证明充分性，即满足这个限制一定有解。如果满足这个限制，说明我们选的任意两个段$$a,b$$，要么$$a$$可以走到$$b$$，要么反过来，要么可以互相走到。所以这是一个竞赛图加上一些重边，我们缩SCC之后还是有一样的结论——得到一条链，沿着链走就可以得到一条合法路径。

然后必要性显然，证完了。复杂度$$O((nm)^2)$$。

-----

期望得分50+100+52=202，实际得分60+15+4=79。

挂分王!

### 讲课

图论咋提宣讲。

Jump

XVI Open Cup, Grand Prix of Asia

https://official.contest.yandex.ru/opencupXVI/contest/2145/problems/C/

http://opentrains.snarknews.info/~ejudge/team.cgi?contest_id=010391

有一个数轴，数轴上有一堆点$$a_i$$，有一堆询问，问你从$$s$$出发，每次选择一个$$a_i$$进行对称，最少几次到$$t$$。$$n\leq 200,v\leq 10^4,q\leq 10^5$$。

考虑对称出来式子的形态，是$$2(a_{p_k}-a_{p_{k-1}}+...+(-1)^{k+1}a_{p_1})+(-1)^ks$$，移个项问题就变成求一堆$$a_i$$的交错和等于$$t-(-1)^ks$$，并且项数尽量少。我们枚举$$k$$的奇偶性，然后就可以得到一个更简单的式子。

考虑拆点，每个点拆成正和负两个点，然后从$$0$$开始跑最短路，胡乱连边即可。复杂度$$O(v\log v+q)$$。

-----

Today is a rainy day

ICPC 2015 Asia East - Beijing Regional

https://icpcarchive.ecs.baylor.edu/index.php?option=com_onlinejudge&Itemid=8&page=show_problem&problem=5275

给定串$$s,t$$，你可以对$$s$$进行若干次操作，每次是修改一位或者把一种字符完全替换成另一种，求把$$s$$变成$$t$$的最小操作数。字符只有123456，$$n\leq 100$$。

考虑替换操作一定可以放到最前面做，所以我们可以枚举一个映射，然后直接搞。映射只有$$6^6$$种，可以接受。

不过怎么才能找到最小操作数呢?考虑最多只有$$6$$次操作，先bfs一下预处理，复杂度就是$$O(6^4)$$的样子，不过它是多少都没问题。

-----

Walk

收录于 优化建图。

-----

树上传送

LYDSY Monthly Contest

https://www.lydsy.com/JudgeOnline/problem.php?id=5129

简单题。直接点分治优化建图。

-----

Travel

http://acm.scu.edu.cn/soj/problem.action?id=4444

有一张完全图，其中$$m$$条边边权是$$a$$，剩下的边权是$$b$$，求$$1$$到$$n$$的最短路。$$n\leq 10^5,m\leq 5\times 10^5$$。

考虑$$1\leftrightarrow n$$的边权。如果是$$a$$，那么答案已经至多是$$a$$了，要想更新答案我们不可能再走$$a$$，此时是保留所有$$b$$边的一个bfs，或者说补图bfs。如果这个边权是$$b$$就很好说。

考虑因为是完全图，我们本来应该每个点都找一遍$$1,...,n$$来着。为了搞快点，如果一个点已经在队列中，我们希望找邻接点的时候跳过它。

每次扔进队列都是删除。删除、查找后继，可以使用并查集或者链表来实现。并查集复杂度$$O((n+m)\alpha(n))$$，或者链表$$O(n+m)$$。

-----

Kirakira

Moscow International Workshop ACM ICPC 2016 Day 3, Division A: SJTU Dreadnought Contest

https://official.contest.yandex.ru/mipt2016autumn/contest/3163/enter/

数学题。用递推处理一个什么东西，然后直接建图跑最大环。具体是啥可以自己看（

-----

新年的繁荣

UOJ Goodbye Yiwei

https://uoj.ac/problem/176

好题。将会收录于 sos-dp。咕咕咕。

-----

病毒实验

JOI Open 2019

https://loj.ac/p/3155

好题。看懂了再写。咕咕咕。

-----

Expectation

矩阵树定理+拉插裸题。

-----

白金元首与独舞

CodePlus 2017 December Contest

https://loj.ac/p/6259

胡乱建图，内向树计数就是了。

-----

生成树

三种颜色的边，求蓝绿边数分别不超过$$g,b$$的生成树个数，膜$$998244353$$。$$n\leq 40$$。

非常简单，直接拿生成函数扔进去，为了快速我们就拉插插出来。

怎么二元多项式拉插?我也不会，好像过几天要讲。咕咕咕。

复杂度$$O(n^5)$$。

-----

生成树计数

Beijing Team Training

https://www.luogu.com.cn/problem/P5296

经典题。用奇怪的生成函数。

-----

C4

AtCoder Grand Contest 051

https://atcoder.jp/contests/agc051/tasks/agc051_d

best定理。咕咕咕。

-----

Binary Code

ICPC 2016, Northeastern European Regional Contest(Northern Eurasia).

https://codeforces.com/gym/101190/problem/B

2-SAT。树上前缀和优化建图。咕咕咕。

-----

Flags

AtCoder Regular Contest 069

https://atcoder.jp/contests/arc069/tasks/arc069_d

还是2-SAT。用神秘分块砍$$\log$$。咕咕咕。

-----

LYZ

16th Polish Olympiad in Informatics

https://szkopul.edu.pl/problemset/problem/kadKFW3YScAMW8o20u0BctQh/site/?key=statement

用Hall定理推式子，转成经典数据结构问题。还是很妙的。

Hall定理说的是，一个二分图，左部点有完美匹配，当且仅当每个左部点子集邻接的右部点个数都至少是这个子集的大小。

咕咕咕。

-----

Rooms

给一张地图，每个房间是极大同色四连通块，每次查一个矩形与多少房间有交。$$n,m\leq 2000,q\leq 5000$$。

复杂度是$$O(q(n+m))$$。

考虑每个连通块选一个关键点，然后先统计矩形内的关键点数量，可以使用二维前缀和。

考虑关键点不在矩形内的所有房间，它们一定跟这个矩形有交。所以我们枚举矩形边上一圈的点，统计关键点在外面的部分。

-----

Xor-matic Number of the Graph

图，边权，对于所有三元组$$(u,v,w)$$满足$$u<v$$，且$$u,v$$之间有一条边权异或和为$$w$$的路径，求$$w$$之和。$$n\leq 10^5,m\leq 2\times 10^5,w\leq 10^{18}$$，膜1e9+7。

类似 最大xor路径。求出所有非树边确定的环，扔进线性基，然后问题变成对于随便一条边权异或和为$$w$$的路径$$u\rightsquigarrow v$$和能被线性基表出的$$x$$，求$$w\ \mathrm{xor}\ x$$的和，因为我们得出的$$w\ \mathrm{xor}\ x$$一定互不相同。

这个$$w$$可以用一个$$d_u\ \mathrm{xor}\ d_v$$得到，其中$$d$$是dfs树上的前缀和。

众所周知可以表出的$$x$$有$$2^{\vert S\vert}$$种，$$\vert S\vert$$是线性基大小。

然后很自然地我们按位考虑。现在问题变成对于每一位求它有多少种方式得出来一个$$1$$。

考虑怎么搞。发现一件事情，就是对于每一位，所有可以表出的$$x$$们在这一位上要么全是$$0$$，要么恰好一半是$$1$$。简单推论是，这个$$x$$不管再异或上什么都仍有这样的性质。

那么我们对于每个全是$$0$$的位，需要选这一位是$$0,1$$的$$d$$各一个；对于每个一半是$$1$$的位，不管怎么选都有一半的$$x$$跟选的$$d$$异或起来得到$$1$$。所以我们设$$c_0,c_1$$表示懂的都懂，这一位被计数的次数就是

$$
c_0c_1+\binom{c_0+c_1}{2}
$$

然后乘上位权和可以表出数的数量，加起来就是答案了。

注意这题图可能不连通，需要对每个连通块分开计算。

-----

Bajtocja

有$$d$$个点集相同的图，一开始都没有边，支持在某个图连一条边，或者查询有多少点在所有图中都连通。$$d\leq 2000,n\leq 5000,m\leq 10^6$$。

考虑每个图开一个并查集，两个点在所有图都连通相当于它们的集合代表元都相同。

给每个点在各图的代表元们进行hash。合并集合的时候，我们启发式地爆力改较小的集合里面的点，复杂度是$$O(dn\log n+m\alpha(dn))$$。用神秘hash table维护hash值，插入删除的同时更新答案即可。

-----

Rally

给一个DAG，可以删一个点，最小化最长路长度。

考虑拓扑排序。枚举删掉的点，那么新的最长路就是咕咕咕。

-----

Tournament cycle

求有多少个有标号竞赛图包含一个大小为$$k$$的环。$$n,k\leq 5000$$，膜$$998244353$$。

结论 : 如果有一个大小为$$k$$的环，那么有所有大小为$$1,...,k$$的环。

我们反过来算，计算有多少个竞赛图没有大小为$$k$$的环。

相当于是说没有大小至少是$$k$$的SCC。

进行dp，设$$dp(i)$$表示$$i$$个点的答案，就可以枚举最后一个SCC的大小，用组合数选出来这个SCC进行转移。

然后问题变成这个SCC的方案数。这是著名问题，可以dp或者带项式预处理。

诶这个dp也可以带项式加速?不知道。

## Day2

### 模拟赛

还是兔队搬题。

T1 segtree

zsy瞎写过了/xia

qlr随机过了/xia

suxxsfe随机55/xia

我输出随机数爆零/xia

原题CF1120D，有魔改。

给一棵树，一开始点权全是$$0$$。你可以进行若干次操作，每次选择一个点，给它的子树都加上一个数。每个点有一个代价$$v$$，每次操作这个点需要支付对应的代价。求最小的代价，使得每个叶子的点权不同。$$n\leq 2\times 10^5,v\leq 10^9$$，你的操作数必须是$$[1,10^9]$$的整数。

这题难点在于构造操作数。

只是求出要操作什么东西的话，非常简单!我们先假设每次操作都可以随便选，那么两个叶子到根的链上，被操作的集合不同，它们的值一定可以不同。

然后你就发现，我们从每个叶子都选了开始贪心，每个点可以选一下来换子树里一个点不选。可以用线段树或者可并堆维护贪心，也可以树形dp。

然后至于怎么构造?直接随机是不行的，因为有生日悖论，$$2\times 10^5$$得把值域开到$$10^{12}$$甚至更多才能稳过。

但是qlr太神了!他写的有冲突就重新随，实践中大约30次就可以得到一组对的。

考虑一个简单结论，每个叶子到根路径上最深的被操作的点一定是不同的，证明显然。

所以这个形成了一个一一对应关系，我们可以利用这件事来操纵每个叶子的权值。

找到被操作点和叶子的对应关系，然后自顶向下进行调整。兔队的做法是钦定每个叶子的值和它的编号膜$$n$$同余，每次操作都把当前点对应的叶子的权值搞对。

复杂度$$O(n)$$。

-----

T2 strhash

终于不挂分了 qwq

另外为什么都是T2最简单啊（

给一个随机字符串，求它所有子串中hash值最大的。基数$$2333333$$，模数$$998244353$$。多组数据，$$T\leq 50,\sum \vert s\vert\leq 2\times 10^6$$。

考虑因为是随机，子串的hash值应该近似于均匀分布，所以从上到下枚举应该期望$$O(\frac{p}{n^2})$$次就可以找到答案。

然后就是怎么判断枚举的答案$$k$$是否可行。考虑推式子

$$
\begin{aligned}
pre_{r}-base^{r-l+1}pre_{l-1}&=k\\
base^{-r}(pre_{r}-k)&=base^{-l+1}pre_{l-1}
\end{aligned}
$$

然后我们就可以枚举一个右端点，用hash table支持查询左端点，如果这个值最小的左端点在枚举的右端点左边那就可行。复杂度$$O(\frac{p}{n^2}n)=O(\frac{p}{n})$$。我忘了预处理幂，多个$$\log$$，但是手写了hash table，跑的飞快（

当$$n$$很小时，可以爆力$$O(n^2)$$。稳得很。

结果因为这题直接小数据爆力，大数据998244352，就可以得到85pts，我被神们吊起来打。

-----

T3 multbfs

原题CF1086F。

3 5 0 0

有一个平面，你要在整点上做多源bfs。一开始有一些bfs的起点，它们的$$dis$$为$$1$$；每次会扩展到切比雪夫距离为$$1$$的点。对所有$$dis$$不超过$$k$$的点的$$dis$$求和。$$n\leq 50,1\leq k\leq 10^8,-10^8\leq x,y\leq 10^8$$，膜$$998244353$$。

把$$dis$$看成时间来考虑。

发现每一时刻，被遍历到的点会扩大一圈，而答案会增加(这一时刻的面积减去上一时刻的面积)乘上这一时刻。

这是一个分段函数，有$$O(n^2)$$个时刻会有一些块撞在一起(枚举两个起点，它们切比雪夫距离的一半上取整就是相交时间)，而每一段内部当然是一个三次函数，可以拉插插出来。

然后怎么单点求值?既然是两个矩形并面积的差，我们可以用扫描线。

不过并没有必要开线段树!瞎写就可以了，复杂度$$O(n^4)$$。

唐椰叶给出了一个$$O(n^2)$$做法。

先切比雪夫转曼哈顿，然后从每个点画横线竖线，会把平面切成$$O(n^2)$$个矩形。为了方便处理，我们在最外圈再加上一个框，并使得这个框外不会被走到。

然后你就发现，每个矩形应该是四个角先被走到，然后从四个角出发扩展到矩形里面的所有(会被走到的)点。所以先求出每个角被搜到的时间。

考虑每两个角所扩展的部分，如果相交，一定有一条分界线，使得两边分别是两个角的贡献。对于邻角是一条横线或者竖线，对角则是一条45度的斜线。这条线可以很容易地算出来，还是距离除以$$2$$就好了。

所以考虑每个角的贡献。

发现它是一个(可能退化的)五边形，比如左下角看起来是这样的

![左下角](/img/2021-05-01-duliu-r1/area.png)

，其中下面和左面的线是矩形边框，上面和右面是和左上角、右下角的分界线，右上是和右上角的分界线。然后我们硬计算它的贡献即可。咋算?不知道/cy反正唐椰叶算出来了。

-----

期望得分24+100+12=136，实际得分0+100+12=112。至少不是挂分王了。

### 讲课

数据结构!

Sinao

有一排草，一开始高度全是$$0$$，每天每棵草会长高$$a_i$$。在若干个$$d_i$$天，兔会吃掉所有高度超过$$b_i$$的草，求每次吃了多少草。$$n,q\leq 10^5$$。

按$$a_i$$排序，每次吃掉的就是一个后缀。线段树维护这个长高的操作，然后二分出吃掉的后缀，再支持推平操作即可。

-----

动态图

离线动态图连通性。

cdq分治。

-----

二分图

懂的都懂!

线段树分治。

-----

直径

树，每次给两个区间，查各选一个点距离的最大值。$$n,q\leq 10^5$$。

直接合并两个集合的直径。使用线段树，$$O(n+m\log n)$$。

用st表，然后建立虚树做四毛子，$$O(n+m)$$。

但是你发现并不能四毛子!因为编号信息量太大。带$$\log$$就带$$\log$$吧。

-----

Painting Edges

线段树分治!

先假设所有操作都被执行了。

不挂操作，而是每次遇到一个操作的左端点，看它会不会被执行，如果不会被执行就把之前的颜色拿过来代替它的颜色。

-----

Segment

懂的都懂!

李超树。

兔讲了一个基于二进制分组的好玩的做法。

这里扯一句无关的 : 二进制分组是分治的不完全执行。

EI的集训队论文，除了烤兔兔还有一个东西，说的是这个问题之类的问题中函数$$\min/\max$$的段数。这里是线段，段数是$$2n\alpha(n)+O(n)$$。

用神秘做法给每组求一个$$\max$$，这个函数段数是$$O(n\alpha(n))$$，合并的时候直接归并或者重构，总复杂度就是$$O(n\log n\alpha(n)+m\log^2 n)$$。据说可以用分散层叠优化掉查询的一个$$\log$$，反正我不会。

-----

楼房重建

我之前写了啥来着......

-----

Election

A和B竞选总统。有一排选民，每个人支持A或B，或者中立。

你要把选民分成若干长度在$$[l,r]$$之间区间的并，每个区间会有一票，这一票将投给区间中支持人数更多的候选人。如果两方支持人数一样多那就弃票。

现在你可以随便划分选民，最大化A的得票减去B的得票。$$n\leq 10^6$$。

把A看成$$+1$$，B看成$$-1$$，中立看成$$0$$。设$$t(x)=[x>0]-[x<0]$$表示一个区间的权值。

$$n^2$$ dp很简单，设$$dp(i)$$表示懂的都懂，有

$$
dp(i)=\min_{j=i-r}^{i-l}dp(j)+t(pre_i-pre_j)
$$

(上下界不知道是不是错了，不过不重要)发现这个后面的东西只和$$pre_i$$与$$pre_j$$的大小有关。这启示我们把$$pre$$扔进状态。

对每个$$pre$$开一个vector，然后这个转移可以用单调队列优化。需要支持在某个单调队列里面插入、删除，查询所有单调队列队首的最大值。

用线段树维护所有队首，做完了。复杂度$$O(n\log n)$$。

因为是$$\pm 1$$，可以再用一个单调队列来维护队首们，做到$$O(n)$$。类似[POI2014] PTA-Little Bird。然而我不会。

-----

文明城市

树，点权，支持修改点权，查询点权和最大的连通块的点权和。$$n,q\leq 10^5$$。

树上ddp。

-----

线段树

有一个序列和一个长$$m$$的操作序列，每个操作是把一个区间推平成这个区间的最大值。

支持对序列的单点修改，以及对执行完一个区间的操作得到的序列做单点查询。$$n,m,q\leq 10^5$$。

考虑倒过来。倒着做，你会发现这个操作相当于合并连续段。

-----

树上的路径

给一棵树，正边权，求$$\mathrm{dis}(u,v)$$从小到大排序之后前$$m$$个值。$$n\leq 5\times 10^4,m\leq 3\times 10^5$$。

二分答案!然后你发现这是仨$$\log$$，T飞了。不过其实只需要先排好序，此后每次统计都是一个$$\log$$的，复杂度就是$$O(n\log n\log m)$$。

另一个做法是，点分治，然后直接转成$$O(n\log n)$$个元素的超级钢琴做。

超级钢琴

序列，求出所有长度在$$[l,r]$$中区间的和拿出来排序之后，前$$k$$个的和。$$n,k\leq 5\times 10^5$$。

先前缀和，问题变成对于$$s_i$$，把$$j\in[i-r,i-l]$$的$$s_i-s_j$$都拿出来参与排序。

考虑开一堆堆来维护这个东西。怎么每次把一整个区间push进去?

这个实际上很简单!我们记录一个三元组$$(i,l,r)$$表示上面那个东西即可。然后它里面的最大值就可以用st表$$O(1)$$查出来。

怎么实现弹掉最大值?我们发现最大值如果是$$j$$，那么去掉$$j$$这个东西分成两部分，分别是$$(i,l,j-1),(i,j+1,r)$$，扔回去即可。

-----

等差数列

单点修改，查询区间重排能不能变成公差为$$k$$的等差数列。强制在线。

经典题。

兔队给了一个更棒的做法，说的是能构成等差数列，等价于满足以下三个条件 : 

 - 最小值减最大值等于$$k(r-l)$$

 - 数不重复

 - 差分数组的$$\gcd$$是$$k$$

，看起来很容易证明。线段树维护最大值、最小值以及差分的$$\gcd$$，主席树二维数点来搞不重复。

注意维护$$\gcd$$的线段树是一个$$\log$$的!复杂度$$O((n+q)(\log n+\log v))$$。

-----

Good Subsegments

给一个排列，每次查一个区间，问有多少子区间构成值域连续段。$$n,q\leq 1.2\times 10^5$$。

简单做法 : 回滚莫队，套一个CF526F的线段树。$$O(n\sqrt{n}\log n)$$。

普通做法 : 再次考虑526F的线段树。

每次右端点右移，影响一个时间后缀。所以每个左端点的查询相当于一个历史最小值和个数的查询。使用吉老师线段树即可。

神仙做法 : 析合树。

-----

Puzzled Elena

有根树，点权，对于每个点，求出子树里有多少点点权和它互质。$$n,a_i\leq 10^5$$。

先莫反!变成对于因数们做一些事情。

子树可以变成区间，然后拆成前缀和相减，然后扫描线扫过去。用一个桶维护，每次插入一个数就把因数们的什么东西扔进桶，查询就查所有因数，复杂度$$O(nd(n))$$。

-----

Odwiedziny

树，点权，每次查询从$$u$$出发跳到$$v$$，每一步跳$$k$$条边，求经过的点权之和。$$n,q\leq 10^5$$。

根号分治。对于超过根号的直接跳，少于根号的预处理$$u$$跳到$$1$$和$$1$$跳到$$u$$的答案，然后拆$$\mathrm{lca}$$即可。$$O((n+q)\sqrt{n})$$。

-----

Bear and Chemistry

无向图，每次查询加入一些边之后，一个点集是否边双连通。询问互不影响。$$n,m,q\leq 3\times 10^5$$，加入的总边数、点数均不超过$$3\times 10^5$$。

边双树。建立虚树然后连上新的边，再求一遍边双即可。奇妙?

-----

Duff is Mad

类似于547E，我们建立ACAM。

然后问题变成，对区间每个串的终止结点子树$$+1$$，求查询串所有点的和。

先对询问进行差分。

根号分治。认为各种东西都同阶。

对于长串，预处理这个前缀和。串个数是$$O(\sqrt{n})$$，每次复杂度是$$O(n)$$，乘起来是$$O(n\sqrt{n})$$。

对于短串，先离线下来。枚举前缀进行子树$$+1$$操作，扫到查询就爆力查。

注意到单点查询的总个数是$$O(n\sqrt{n})$$，但是子树$$+1$$只有$$O(n)$$次，所以可以用根号平衡干掉BiT的$$\log$$。总复杂度$$O(n\sqrt{n})$$。

-----

A Text Problem

有一个串$$t$$，每次查询一个$$s$$，求$$s$$在$$t$$中允许一个位置不同的匹配次数。$$\sum\vert s\vert,\vert t\vert\leq 10^5$$可以强制在线。

考虑建立$$t$$的前缀树和后缀树，然后枚举$$s$$那个不同的位置，分别求出此时$$s$$的前缀/后缀对应的$$t$$的前缀/后缀树上的结点。然后相当于求同时在两个子树中的所有$$pos$$个数，发现子树是区间，于是变成二维数点，主席树即可支持在线。

-----

Matches Are Not a Child's Play

3 4 0 0

树，点权，定义它的删除序列为 : 每次删除权值最小的叶子，把这些叶子的编号按删除顺序排列。

支持修改一个点的点权为比当前最大值更大的值，或者查询一个点在删除序列中的位置。

考虑每次操作之后，相当于把操作点和原来最大值的链全都移到删除序列的末尾。

考虑LCT维护连续段，然后同时用平衡树维护序列。做完了。

具体怎么做完了?我也不知道，反正兔做完了（

## Day3

### 模拟赛

猫(cyx,nealchen)的题。

T1 city

给一个字符串，串只有abc三个字符。定义一个串的美丽度是它的长度的平方除以最小循环节的长度，求这个串所有子序列美丽度的最大值。$$n\leq 10^5$$，$$10$$组数据。

考虑所有字符中出现次数最多的，它至少出现了$$\lceil\frac{n}{3}\rceil$$次，贡献是$$\lceil\frac{n}{3}\rceil^2$$。

所以如果拿这个初始化答案，则一个串要想更新答案，它的

考虑随便一个子序列，假设它的循环节长度是$$m$$，一共循环了$$k$$次，那么这个串的答案是$$k^2m$$。

显然它最多的字符在每一个循环节至少出现$$\frac{m}{3}$$次，我们把这个单独取出来，它的最小循环节长度是$$1$$，所以得到的答案是$$\left(k\lceil\frac{m}{3}\rceil\right)^2$$。

这就非常好，我们把这两个式子搞一下，得到要想用一个循环节不是$$1$$的串更新答案，必有$$\lceil\frac{m}{3}\rceil^2<m$$。

你发现只有$$m=1,2,3,5,6$$才满足这个限制，所以我们先爆搜出来。

然后非平凡循环串一定没有用，所以我们可以跑一遍kmp筛去循环串。这样只剩下$$99$$个串，硬跑就可以过了。

-----

T1.5 field

经典网络流题，因为太广为人知被换掉了。

-----

T2 qaq

有$$n$$个盒子，每个盒子里面有一些带编号的球，一开始第$$i$$个盒子里有且仅有$$a_i$$个编号是$$i$$的球。

接下来你可以按顺序进行$$m$$次操作，每次操作你会拿到两个盒子编号$$x,y$$，你可以选择从这两个盒子里面各拿出一个球交换，或者不做任何操作。

最大化最后盒子$$1$$中不同编号球的数量。$$n,m\leq 3000$$，$$10$$组数据。

还是经典网络流题。

考虑实际上只有最后到了$$1$$的球才有用，并且相同编号的球只有一个有用，我们不妨把问题修改一下，每个盒子里只有一个球，别的都是纸片。

这样就可以考虑球的交换，它可以抽象成流。

我们建立$$m$$层图，一开始给每个盒子分一个球，然后每次交换就是两个盒子之间连两条边。注意这里可以不拆点。每个盒子向下一层的盒子连它的大小，表示不能有多的球换过来。

然后你发现实际上每层只有一次交换，所以我们可以去掉所有没换的，实现中直接让每个时刻连向下一次被操作的时刻即可。

常数可能影响得分!猫表示写Dinic可以从$$t$$出发反着bfs分层，这样可以筛去很多不能到达$$t$$的点。注意$$s$$不能到达的点根本不会被dfs搜到，所以不影响效率。或者你写HLPP那肯定稳了啊（

复杂度$$O(\mathrm{maxflow}(n+m,n+m))$$。

-----

T3 world

有$$m$$件物品要全分给A和B，两个人的物品栏各有$$n$$个格子，第$$i$$件物品只能放在A的$$x_i$$格子或者B的$$y_i$$格子，并且如果分给A会把A的得分增加$$a_i$$，给B则会把B的得分增加$$b_i$$。最小化两个人的得分乘积。$$n\leq 5\times 10^5,m\leq 2n,a_i,b_i,\leq 10^6,\sum a_i,\sum b_i\leq 2\times 10^9$$。

每个物品栏的格子建一个点，把物品抽象成$$(A_{a_i},B_{b_i})$$的边，现在我们要定向，指向哪个格子就是分给哪个格子。你发现每个点只有一条入边，所以形成了一个外向基环树森林。等等，也有可能是树，因为有的格子可能没有放东西。

考虑把两个人的得分看成平面上的坐标，那么我们要最小化乘积就是拿$$xy=k$$去切，所以我们知道答案一定在下凸壳上。对于基环树我们搞出两种定向的得分，对于树直接就是一个点，然后依次合并它们——这是闵和，最后直接枚举下凸壳上的点得到答案即可。复杂度瓶颈是闵可夫斯基和的$$O(n\log n)$$排序。

-----

期望得分40+0+0=40，实际得分0+0+0=0。/kk

### 讲课

概率期望!

猫毒瘤!

-----

AGC028B Removing Blocks

考虑把和转成期望!

考虑一个线段贡献了多少次。这是快排啊!

考虑一棵划分的树。如果$$i$$被干翻的时候$$j$$产生了贡献(不妨先讨论$$i<j$$)，说明$$i$$被干翻的时候$$[i+1,j]$$都还没被干翻，也就是$$[i,j]$$中$$i$$第一个被干翻。因为时间是均匀随机的排列，这个概率应该是$$\frac{1}{j-i+1}$$。对所有$$i,j$$求和就得到答案。注意这是$$i<j$$的部分，$$i>j$$要反过来，不过其实乘$$2$$就可以了。注意这是期望，还要乘上情况数也就是$$n!$$才是答案。

-----

CF605E Intergalaxy Trips

当然设$$E_u$$表示$$u$$走到$$n$$的期望。

考虑即使在期望意义下，最短路的贪心还是成立的，也就是说我们会尽量走到一个$$E$$更小的邻接点。所以我们得到一个式子

$$
E_u=\frac{1}{1-\prod_{v}(1-p_{u,v})}\sum_{u\rightarrow v}p_{u,v}E_v\prod_{E_w<E_v}(1-p_{u,w})
$$

这个式子前面那个$$\prod$$说的是至少一条边开放，也就是能走出去的概率；后面那个$$\prod$$说的是比$$v$$更优的邻接点都走不动的概率。

所以有一个想法，我们按照$$E$$从小到大处理，这样就可以保证处理到一个点的时候，它的转移就是它周围所有处理过的点(，而不会出现没处理过的点)。这个不就是Dij吗!

首先$$E$$最小的肯定是$$n$$，我们把它扔进一个堆，每次取出堆顶在反图上进行更新。瞎维护就好了。

-----

CTS2019 随机立方体

先把概率转成计数。

然后进行二项式反演，把 恰好 变成 钦定。

钦定出$$k$$个各维坐标都分别不相同的格子很简单，方案数就是$$\frac{n^\underline{k}m^\underline{k}l^\underline{k}}{k!}$$。接下来问题是怎么让它们极大。

考虑给这些格子一个顺序，也就是钦定出一个序列而不是一个格子集合，方案数变成$$n^\underline{k}m^\underline{k}l^\underline{k}$$。然后我们令这个序列从小到大。

考虑如果第$$i$$个选出来的格子极大，那么就可以确定一堆大小关系。

首先这个格子填的数需要比所有和它有一维坐标相同的格子大，然后还要比之前那$$i-1$$个选的格子大，咕咕咕。

-----

FJOI2019 新家具设计方案

给一个$$k$$维空间中的点集$$S$$，每次询问一个子集$$T$$，求有多少点满足各维都是非负整数、和不超过$$s$$，并且左下角的$$S$$中的点恰好是$$T$$。$$\vert S\vert\leq 20,s\leq 10^5,q\leq 10^5$$，各维都不超过$$10^5$$，不取膜/jy

爆搜，考虑把恰好换成至少，这个可以求出当前子集的各维最大值，然后组合数选出来。

然后你发现我们算出来的其实是一个子集前缀和，可以差分回去。

-----

CF963E Circles of Waiting

直接高消没有前途。主元法。

考虑拿从上往下看到的所有点的期望当做主元，然后如果我们知道了一个点左边，右边，上边点的期望，就可以得到这个点的期望，于是可以递推得到圆下面所有点用主元表示的期望。它们的期望应该是$$0$$，于是得到$$2r$$个方程，解即可。复杂度$$O(r^3)$$。

-----

uoj442 集训队作业2018 小Z的礼物

min-max容斥+轮廓线dp/jy

先min-max容斥，然后问题变成对于每个子集求它中第一次有黑格子被覆盖的期望时刻。

然后是轮廓线dp。不会轮廓线dp。咕咕咕。

-----

表达式求值

给一个表达式，只有加减乘和括号还有一些未知数(用$$\_$$表示)，现在给每个未知数随机$$[1,n]$$中的整数但不重复，求式子的期望膜1e9+7。$$\vert S\vert\leq 5\times 10^4,n\leq 10^9$$。

乘法没有线性性。

注意到比如$$(\_+\_)\times (\_+\_)$$这样的式子，拆开括号，它就是$$\_\times \_+\_\times \_+\_\times \_+\_\times \_=4\_^2$$!为什么?因为每个未知数是完全平等的。

这就很好。这说明最后我们得到一个多项式，每一项都是$$a_k\_^k$$，次数是最多乘号个数次，我们爆力模拟求出它的各项系数，然后就可以利用线性性拆开各项的贡献。

设$$g(m)$$是$$m$$个$$[1,n]$$之间无序且互不相同的随机数乘起来的期望。那么答案就是

$$
\sum_m a_mg(m)
$$

接下来问题就是求出这个$$g(m)$$了。考虑设一个$$h(m)$$表示对于上面那个东西的所有情况求和，那么$$g(m)=\frac{h(m)}{\binom{n}{m}}$$。当然猜测这个$$h$$是关于$$n$$的$$m$$次多项式，我们可以用下降幂多项式进行递推。复杂度$$O(\vert S\vert^2)$$。

咋递推?这是后天的锅/xia咕咕咕。

-----

AGC013E Placing Squares

咕咕咕。

进行dp，设$$f(i)$$表示强制在$$i$$这里分的所有方案的权值和，可以写出转移

$$
f(i)=\sum_{j\notin X}(i-j)^2f(j)
$$

这个dp看起来很难优化。不过也可以!你谷题解区有人直接硬推推出来了。据说本质是拆下降幂，这个东西等我学了再补，咕咕咕。

哦我们来拆一下。

兔和猫的做法都是考虑组合意义，组合意义天地灭!

-----

CF917D Stranger Trees 加强版

$$n\leq 5000$$。

原题$$n\leq 100$$，可以矩阵树定理+拉插干翻它!但是$$5000$$并不能这么做。

先二项式反演掉$$k$$，问题转化成钦定$$k$$条边重合、剩下随意的方案数，然后就可以缩起连通块，用Prufer定理来生成树计数。

然后我们得到方案数是

$$
n^{n-k-2}\prod s_i
$$

，其中$$s$$是连通块大小。

然后问题变成，求所有钦定$$k$$条边的方案中，各连通块大小积的和。

可以树形dp!然而并不好做。

考虑组合意义，是在每个连通块选一个点的方案数。(打 脸)

我们设$$dp(u,i,j,0/1)$$表示 $$u$$子树内选了$$i$$条边和$$j$$个点，根节点所在的连通块没有/有选点 的方案数，复杂度是树卷积的复杂度$$O(n^2)$$。

-----

顺子

对于一个排列，定义它的一个顺子区间是一个值域上连续并且递增或递减的区间。

求长度为$$n$$，且所有顺子区间长度都不超过$$m$$的排列个数。$$m\leq n\leq 5000$$，膜1e9+7。

等价于没有长度是$$m+1$$的。

考虑容斥，我们钦定一些长度是$$m+1$$的顺子。

如果两个顺子有交，它们一定同增或同减。

咕咕咕。

-----

AGC024E Sequence Growing Hard

考虑如果我们第$$i$$次把$$v_i$$放到位置$$p_i$$前面，那就需要$$v_i>A_{i-1,p_i}$$。

考虑按加入时间排序，那么

咕咕咕。

-----

CF506E Kitayuta's Gift

咕咕咕。

-----

loj Beta Round #7 匹配字符串

考虑dp，有$$f(i)=2f(i-1)-f(i-m-1)$$，那个减就是考虑选$$1$$不行的情况。

现在显然可以爆力多项式取膜了!做完了。

另一种做法是转成DAG上带权路径计数问题，咕咕咕。

-----

FJOI2020 凸多边形正则划分问题

求把一个$$(k-2)n+2$$边形划分成$$n$$个凸$$k$$边形的方案数。多组数据，$$3\leq k\leq 200,n\leq 555555,\sum n\leq 10^8$$，1s 1GB，膜1e9+7。

直接拉格朗EI反演。

组合做法 : 对偶图，变成求$$n$$个点的无标号无根$$k$$叉树计数，并且儿子有序。咕咕咕。

## Day4

### 模拟赛

兔良心!

-----

T1 degree

兔 : 大家开动脑筋乱搞就好了

给一张无向连通图，没有自环但是可能有重边，求一种定向方案，使得每个点$$u$$满足两个限制 : 入度至少是$$x_u$$，出度至少是$$y_u$$，构造方案，不存在输出-1。$$n,m\leq 5\times 10^5$$，注意$$x_i,y_i\leq 1$$。

三种做法 : 上下界网络流，玄学，缩点。

suxxsfe和zsy写了上下界网络流。不必多说。

sqy和dwt写了玄学。

考虑干翻所有度为$$1$$的点。干翻之后剩下一个有欧拉回路的图，所以可以随便求一个欧拉回路分解。

问题出在可能有度为$$1$$的点没有限制，此时就需要胡乱处理它的边。

我和峰写了缩点。

先缩e-DCC，每个e-DCC可以按照dfs时的方向定向成SCC，而SCC中每个点只有一条入边一条出边。

接下来在树上乱搞即可。

He_Ren直接dfs树!给非树边打标记，然后做树的即可。

-----

T2 digits

原题CF778E。

给一堆数$$b_i$$和一个怪数$$a$$，$$a$$里面有一些?，你可以在?上填数。给出$$0,...,9$$的权值$$c_0,...,c_9$$，定义$$f(x)$$表示$$x$$各位权值之和，你需要把$$a$$填完，使得它前面没有前导0，并且$$\sum f(b_i+a)$$最大。$$n\leq 1000,a,b_i$$位数都不超过$$1000,c_i\leq 1000$$。45pts是$$n\leq 8$$。

考虑数位dp，设$$dp(i,S)$$表示处理完了前$$i-1$$位，当前位有$$S$$中的数进位了的最大权值。转移显然。复杂度$$O(10len\cdot 2^nn)$$。

考虑一件很有意思的事情，对于每一位，如果不考虑上一位的进位，这一位只有最多$$\min(n+1,10)$$种进位情况。因为我们按这一位从大到小排序之后，每次进位的一定是一个前缀。

实际上，即使考虑上一位的进位，这一位也最多只有$$n+1$$种进位情况。假设处理到$$i$$位，按照前$$i$$位字典序从大到小排序，不管$$i-1$$位如何进位，由于$$i$$位的位权超过$$i-1$$位，并且$$i$$位上进位进出来的$$x$$一定不如原来就在$$i$$位上的$$x$$大，前$$i$$位的字典序不会改变。

我们可以用基数排序预处理排序的结果，排序不是复杂度瓶颈，那么接下来问题就是怎么优化转移。

诶你发现这个转移性质也比较优秀，因为每次进位的是一个前缀，我们可以很容易地$$O(n)$$递推转移需要的值。复杂度$$O(n\cdot len)$$。

-----

T3 jump

有一棵树，有一个棋子在$$1$$号点，现在Alice和Bob两个人玩游戏，Alice先手，每个人每一次要把棋子移动到另一个点去，要求这一步移动距离必须大于上一步。Charlie现在要砍去一些子树，问对于所有不同的砍子树的情况，有多少种是Bob后手必胜。$$n\leq 2\times 10^5$$，膜$$998244353$$。

考虑一个简单结论，两个人都不会走到任何一个直径端点，因为走直径就可以逼得对方无路可走。

所以我们可以标记直径端点为不可达。那么接下来重新求出直径，又会多出来新的不可达点......最后可以想象只有center留了下来。

问题变成计数有多少删子树的方案会留下$$1$$作为center。

考虑$$1$$是center的话，一定会有两条路径连出去构成直径。

dp，设$$dp(u,i)$$表示$$u$$子树内砍到最大深度为$$i$$的方案数，考虑两个儿子$$v,w$$，可以写出方程

$$
dp(u,\max(i,j))\leftarrow dp(u,\max(i,j))+dp(v,i)dp(w,j)
$$

直接转移复杂度是树卷积的$$O(n^2)$$，可以获得72pts!

你发现这是一个$$\max$$卷积，可以用前缀和-差分优化，不过这对复杂度并没有帮助......

接下来可以用长链剖分优化，式子什么的等我学了长剖再推。线性做法非常毒瘤，建一棵线段树维护转移会简单不少。

最后我们在$$1$$处进行合并即可。

-----

期望得分100+45+8=153，实际得分100+45+16=161。完全没挂!

### 讲课

CF咋提宣讲。

几乎全是黑色，快点水经验啊/jy

-----

CF724E Goods transportation

显然最大流。建图是$$s\stackrel{p_i}{\longrightarrow}i,i\stackrel{c}{\longrightarrow}j,i\stackrel{s_i}{\longrightarrow}t$$。

然而这个跑不了1e4。(啊?CF不是2s 1e12吗?)

考虑dp。要dp最大流太**困难了，我们转成最小割。

设$$dp(i,j)$$表示考虑前$$i$$个点，有$$j$$个在$$s$$这边的方案数。(当然剩下的都在$$t$$边)

如果我们让$$i$$在$$s$$这边，就需要割掉它到$$t$$的边，这个代价是$$dp(i-1,j-1)+s_i$$。

否则，除了割掉到$$s$$的边，还需要割掉前面的$$s$$那边的点连过来的边，于是可得代价是$$dp(i-1,j)+p_i+jc$$。

注意这是CF，2s 1e8完全没问题。

不过有一个$$O(n\log n)$$的优秀做法。考虑一开始我们让每个点都割$$s$$，接下来选择一些点改为割$$t$$。

一个点不割$$s$$而转为割$$t$$，它的贡献是$$-p_i+s_i$$。

注意割$$t$$的话还需要割掉连向后面跟$$t$$相连的点的连边，这个点数我们也不确定是多少/yun

不过你发现如果我们直接按照$$n-i$$算，假设最后选了$$k$$个点，则会多算$$\binom{k}{2}$$次。我们枚举选了多少，这样就可以直接按照$$-p_i+s_i+c(n-i)$$排序来选，再减掉多算的。复杂度$$O(n\log n)$$。

-----

CF793F Julia the snail

当然离线下来按$$r$$排序。你发现查询变成了某种单点查询，于是考虑修改对点的贡献。

然后发现对于梯子$$l,r$$，如果$$i$$这个位置有$$l\leq ans_i$$，那么我们把它推平成$$r$$，这个操作比取$$\max$$要强力，可以用吉老师线段树维护。(为什么说强力?因为要足够强力的操作才能带来正确的均摊复杂度)

-----

CF802O April Fools' Problem (hard)

雪 灾 与 外 卖

-----

CF827F Dirty Arkady's Kitchen

如果数据范围没这么大，一个显然的做法是分层图。

但是数据范围有这么大就不好了。

注意到到达一个点的可行时刻大体看是一些区间，但是一个区间中间可能是断断续续的，这是因为每一时刻都必须走一步，可能会出现必须在一条边上来回走的情况。

我们进行拆点，拆成奇点偶点，分别只考虑奇数和偶数时刻的可达性，这样就可以把断断续续的变成区间。如果一条边开放，完全可以走过去走回来，所以如果$$i$$时刻$$u$$可达，那么$$i+2,i+4,i+6,...$$时刻都可达。当然同时我们也要拆边。

考虑按照边的出现时间从小到大处理。当我们加入一条边的时候，可以用它去更新它的所有

-----

CF908H New Year and Boolean Bridges

注意到不可能有$$f(u,v),f(v,u)=0$$，所以这个图弱连通。

A表示在同一个SCC，我们可以在链上加一条边，形成一个环，串起一个SCC。

O表示弱连通，所以没啥限制。

X表示不在同一个SCC。

你发现最多有23个大小至少是$$2$$的SCC

-----

CF932G Palindrome Partition

考虑转成普通的回文!然后用PAM瞎做。

把右半边折过来，然后拍到一起，比如

abc|de|f|f|de|abc

变成

abc|de|f\
cba|ed|f

拍成

acbbca|deed|ff

这就非常好。然后就变成了偶回文串划分计数。在PAM上跳fail来转移，或者直接用Manacher来判回文，容易做到$$O(n^2)$$。

然后是什么弱周期引理?不会，学了再补，咕咕咕。

类似于这个题的转化，还有一个奇妙的字符串题，说的是两个串lcp和lcs(suffix)的min，就是这两个串分别乱拼起来的lcp，这个乱拼方法是把123456789拼成192837465。

-----



## Day5

### 模拟赛

害 怕

今天又是挂分王!

-----

T1 acquine

给一张完全图，每次询问一个子集的最小斯坦呐树。$$n\leq 21,q\leq 10^5$$，边权在`int`范围内，256MB空间。

考虑对每个子集求出MST，然后做子集后缀和。

我写了个假上天的做法......直接随便钦定一个点，让它和剩下的点连一条边。然而这个钦定的点在MST上不一定是叶子，所以我就假了。

所以怎么做?

考虑Prim。

你发现256MB刚好开不下$$O(2^nn)$$个`long long`，但是刚好可以开`int`!我们预处理$$g(u,S)$$表示$$u$$到$$S$$的最小边权，那么就可以把转移优化掉一个$$n$$。

其实，如果你发现这个评测机机子不错，你就可以$$O(2^nn^2)$$硬草!dwt就这么过了/jy

-----

T2 easy

给一个字符串，每次查询一个区间的本质不同子序列数量。$$n,q\leq 10^6$$，膜1e9+7。

写了个1e5，字符集9的部分分。就是转成子序列自动机上路径计数，然后你发现这个dp可以用矩乘优化，这个矩阵大小是$$\vert\Sigma\vert+1$$。然后用线段树维护，矩阵乘向量，复杂度$$O(n\vert\Sigma\vert^3+q\vert\Sigma\vert^2\log n)$$。可以矩阵求逆+前缀和砍那个$$\log$$，不过前面那个$$\vert\Sigma\vert^3$$确实太慢了。

正解是拆掉这个矩阵，变成非常奇妙的东西。感觉不是人类能想到的。

-----

T3 trivial

给一棵树，每个点有一个颜色，求有多少选取两条无序路径的方案，使得两条路径没有交，并且每条路径的两个端点颜色相同(两条路径的端点颜色不必相同)。

有$$m$$次操作，每次ban掉一个点，不能选取这个点作为路径的端点。询问之间独立。$$n,m\leq 10^5$$。

考虑枚举一条路径，统计另一条。

直接算好像不是很容易，我们考虑反过来，算经过这条路径的路径数。

考虑如果另一条路径$$(c,d)$$跟我们枚举的路径$$(a,b)$$有交，一定有$$\mathrm{lca}(c,d)$$在$$a\rightsquigarrow b$$上，或者$$\mathrm{lca}(a,b)$$在$$c\rightsquigarrow d$$上。

画个图你发现我们可以用这两个东西把它们凑出来 : $$f(u)$$表示$$u$$子树内选两个点同色且经过$$u$$的方案数，$$g(u)$$表示整棵树内选两个点同色且经过$$u$$的方案数。对于$$\mathrm{lca}(a,b)$$，经过它的路径数量是$$g(\mathrm{lca}(a,b))$$；对于路径上其它点$$u$$是$$f(u)$$。

怎么求这两个鬼东西?可以对每种颜色建立虚树，然后对于一种颜色，它对虚树上一条边经过的所有点的$$f,g$$的贡献应该是相等的(当然对$$f$$和对$$g$$的贡献不相等)，可以用一个树上差分来维护。

好了接下来就非常简单了!我们对$$f$$做树上前缀和(到根的链和)，记为$$s$$，然后选每一对$$a,b$$之后不合法的$$c,d$$数量就可以愉快差分出来，这个就是$$s(a)+s(b)-2s(\mathrm{lca}(a,b))+g(\mathrm{lca}(a,b))$$，容易$$O(1)$$求得。总路径数就是$$S=\sum f(u)$$，对于每对点，用总路径数减去上面的不合法的数量，再加起来就是答案。

这样我们就得到了一个$$O(n^2)$$的做法!

如何优化?考虑对于每一个$$u$$，$$S-s(u)$$会被算 与$$u$$同色的点个数$$-1$$ 次，可以直接干掉。主要问题在于$$s(v)-2s(\mathrm{lca}(u,v))+g(\mathrm{lca}(u,v))$$，我们按照套路枚举lca统计答案。设这个lca是$$w$$(注意$$w$$不一定与$$u,v$$同色，但是一定在$$u,v$$颜色构成的虚树上)。

 - 如果$$u=w$$，那么只需要考虑$$s(v)$$，这个$$v$$可以任意在$$u$$的子树里面选(，当然不能跟$$u$$相同)，所以我们只需要记录每个点子树里面所有和它同色的点的$$s$$之和，这个可以再在虚树上dfs解决。

 - 如果$$u\neq w$$，考虑$$w$$的另一棵子树$$x$$，$$x$$中所有与$$u$$同色的点都可以与$$u$$产生贡献。可以直接对每棵虚树上每个点$$u$$，统计这棵虚树上$$u$$子树中所有颜色正确的点的$$s$$之和，然后每次用$$w$$的其它子树去更新一棵子树，可以在虚树上打标记然后下传。

等等现在我们还不支持ban掉一个点。

事实上只需要计算经过每个点的路径数量就可以了。你发现刚才算的就是这个/jy

唐椰叶写了5kb。不会有人想写吧/jy

-----

期望得分100+80+10=190，实际得分8+80+10=98。T1挂惨了。

### 讲课

没有法法塔的多项式，和线性代数!

猫毒瘤/kel

-----

随机数生成器

给一个随机数生成器(xorshift)，给定种子，求第$$n$$次生成的数。2e5组数据，$$n\leq 10^{18}$$。

```cpp
unsigned long long rand()
{
	static unsigned long long seed;
	seed^=seed<<13;
	seed^=seed>>17;
	seed^=seed<<5;
	return seed;
}
```

看成膜$$2$$意义下的多项式，然后就可以写出一个元素是多项式的矩乘，这就非常好。快速幂即可。

注意数据组数非常多，可以k进制矩乘来加速。

-----

FJOI2018 城市路径问题

$$n$$个城市，第$$i$$个城市有$$2k$$个点权$$(a_{i,1},a_{i,2},...,a_{i,k};b_{i,1},b_{i,2},...,b_{i,k})$$。

从城市$$u$$直接到$$v$$一共有$$\sum_{i=1}^ka_{u_i}b_{v,i}$$种方案，$$u$$可以等于$$v$$。

每次查询$$u$$不超过$$d$$步到$$v$$的方案数。

$$n\leq 1000,d<2^31,k\leq 20,q\leq 50$$，膜1e9+7

做法很简单。考虑搞两个矩阵$$A,B$$分别是所有点的点权向量拼起来，当然其中一个要转置。你发现邻接矩阵就是$$AB$$，幂就是$$ABABABAB...$$。

这个看起来就很有意思，我们把它改成$$A(BA)(BA)(BA)...B$$，然后你发现$$AB$$是$$n\times n$$的，但是$$BA$$只有$$k\times k$$，所以可以直接快速幂搞这个东西。复杂度$$O(q(n^2+k^3)\log d)$$。

-----

循环矩阵行列式

题不是这样的!本来有一个Matrix-tree的皮。

$$n=2^m$$的矩阵$$A$$

$$
A=
\begin{bmatrix}
a_0&a_1&a_2&\cdots&a_{n-1}\\
a_{n-1}&a_0&a_1&\cdots&a_{n-2}\\
\vdots&\vdots&\vdots&\ddots&\vdots\\
a_1&a_2&a_3&\cdots&a_0
\end{bmatrix}
$$

，求行列式，膜$$998244353$$。

经典构造。

我们构造矩阵

$$
M=
\begin{bmatrix}
\omega_{n}^0&\omega_{n}^0&\omega_{n}^0&\cdots&\omega_{n}^0\\
\omega_{n}^0&\omega_{n}^1&\omega_{n}^2&\cdots&\omega_{n}^{n-1}\\
\omega_{n}^0&\omega_{n}^2&\omega_{n}^4&\cdots&\omega_{n}^{2(n-1)}\\
\vdots&\vdots&\vdots&\ddots&\vdots\\
\omega_{n}^{0}&\omega_{n}^{2(n-1)}&\omega_{n}^{3(n-1)}&\cdots&\omega_{n}^{(n-1)(n-1)}
\end{bmatrix}
$$

。首先这是一个范德蒙德矩阵。

为什么这么构造?因为循环矩阵$$A$$的转转转跟单位根的转转转放在一起会有奇妙的事发生!

我们设$$f(z)=\sum_{i=0}^{n-1}a_iz^i$$。

考虑$$AV$$，你用脑子想象一下，发现它就是

$$
AM=
\begin{bmatrix}
f(\omega_{n}^0)&f(\omega_{n}^0)&f(\omega_{n}^0)&\cdots&f(\omega_{n}^0)\\
\omega_{n}^0f(\omega_{n}^0)&\omega_{n}^1f(\omega_{n}^1)&\omega_{n}^2f(\omega_{n}^2)&\cdots&\omega_{n}^{n-1}f(\omega_{n}^{n-1})\\
\omega_{n}^0f(\omega_{n}^0)&\omega_{n}^2f(\omega_{n}^2)&\omega_{n}^4f(\omega_{n}^4)&\cdots&\omega_{n}^{2(n-1)}f(\omega_{n}^{2(n-1)})\\
\vdots&\vdots&\vdots&\ddots&\vdots\\
\omega_{n}^0f(\omega_{n}^0)&\omega_{n}^{n-1}f(\omega_{n}^{n-1})&\omega_{n}^{2(n-1)}f(\omega_{n}^{2(n-1)})&\cdots&\omega_{n}^{(n-1)(n-1)}f(\omega_{n}^{(n-1)(n-1)})\\
\end{bmatrix}
$$

好像看到了法法塔!我们还需要一步 : 

$$
\vert AV\vert=\left(\prod_{i=0}^{n-1}f(\omega_{n}^i)\right)\vert V\vert
$$

这是为什么?考虑你选一个排列，它在每一行一定恰好选到一个，所以一定会乘一个$$\left(\prod_{i=0}^{n-1}f(\omega_{n}^i)\right)$$，所以我们可以提出来，剩下的就是$$\vert V\vert$$了。

然后就可以两边除掉$$\vert V\vert$$。这样做的可行性，考虑范德蒙德行列式，因为$$\oemga_n^k$$互不相同，这个行列式非$$0$$，所以可以两边同时除掉。

于是我们就得到了

$$
\vert A\vert=\prod_{i=0}^{n-1}f(\omega_{n}^i)
$$

，可以使用法法塔计算。

-----

数排列

给一个排列$$q$$和一个序列$$h$$，定义一个排列$$p$$的权值

$$
v(p)=\sum_{i=1}^n\sum_{j=i+1}^n([p_i>p_j]+[p_i+h_i\geq q_j])
$$

，求有多少长$$n$$的排列$$p$$使得$$v(p)$$是偶数。$$n\leq 300$$，膜$$998244353$$。

排列奇偶性，你想到了什么?

考虑偶数有$$1$$的贡献，奇数有$$0$$的贡献，就很不好。

考虑先乘个$$2$$，最后除回来。然后变成偶数有$$2$$的贡献，奇数有$$0$$的贡献。这还不是很好。

接下来我们全$$-1$$，最后加上一个$$n!$$，这样偶数有$$1$$的贡献，奇数有$$-1$$的贡献。这就很好了。

答案的式子是$$\frac{n!+\sum_{p}(-1)^{v(p)}}{2}$$，于是现在我们要计算$$\sum_{p}(-1)^{v(p)}$$。

你发现$$v(p)$$的式子里面第一个艾弗森括号是逆序对，第二个不知道是什么。不过我们可以把它拆出来。

$$
\begin{aligned}
&\sum_{p}(-1)^{v(p)}\\
=&\sum_{p}(-1)^{\sum_{i=1}^n\sum_{j=i+1}^n([p_i>p_j]+[p_i+h_i\geq q_j])}\\
=&\sum_{p}(-1)^{\sum_{i=1}^n\sum_{j=i+1}^n[p_i>p_j]}\prod_{i=1}^n(-1)^{\sum_{j=i+1}^n[p_i+h_i\geq q_j]}\\
=&\sum_{p}(-1)^{\sum_{i=1}^n\sum_{j=i+1}^n[p_i>p_j]}\prod_{i=1}^na_{i,p_i}
\end{aligned}
$$

于是得到$$a_{i,j}=(-1)^{\sum_{k=i+1}^n[j+h_i\geq q_j]}$$。高消行列式即可。

-----

CF1336E1



CF1336E2

-----

九个sun

单位根反演，二项式定理。

-----

复读机

EGF，单位根反演，多项式定理。

猫昕给了一个奇妙做法，不是很懂/kk

-----

爆炸oj3453 XLkxc

你发现里面是$$k+1$$次多项式，可以插值。

你发现中间是$$k+2$$次多项式，可以插值。

你发现外面是$$k+3$$次多项式，可以插值。

做完了/jy

-----

NOI2019 斗主地

结论是，洗牌不会增加次数。

这个结论是怎么得出来的?考虑

-----

AGC020F Arcs on a Circle

-----

随机游走

有一个醉汉站在原点，他有$$p_1,p_2,p_3,p_4$$的概率向四个方向走一步，求走$$n$$步之后他经过的点数期望。$$n\leq 50$$，保留三位小数。

-----

NOI2019 机器人

-----

FJOI2021 外星飞碟

有一个数列$$a_1=0,a_2=1,a_n=\frac{na_{n-1}+n(n-1)a_{n-2}}{2}+(-1)^n(1-\frac{n}{2})$$。

求$$\sum_{i=1}^n\binom{n}{n-i}(n-i+1)a_i$$，膜任意数。$$n\leq 10^{19},p\leq 11223372019$$，时限10s。

看到递推式这个奇怪的东西你就觉得很不好。不过我们可以除一个$$n!$$ : 

$$
\begin{aligned}
a_n&=\frac{na_{n-1}+n(n-1)a_{n-2}}{2}+(-1)^n(1-\frac{n}{2})\\
\frac{a_n}{n!}&=\frac{1}{2}\left(\frac{a_{n-1}}{(n-1)!}+\frac{a_{n-2}}{(n-2)!}\right)+\frac{(-1)^n}{n!}+\frac{n}{2(n-1)!}+\frac{}{}
\end{aligned}
$$

然后就可以考虑EGF/se

$$
s
$$

## Day6

### 模拟赛

T1 breeze

原题CF838D Airplane Arrangements。

考虑没有座位这个事情很难受，我们在两边加两个座位，这样问题就变成了这两个新座位没有人坐。

两个座位也不是很好，我们把两个座位变成一个，此时变成了一个环。问题变成那一个座位没有人坐。不考虑限制一共有$$(2(n+1))^m$$种情况。

你发现环是对称的，所以每个座位都有$$\frac{n-m+1}{n+1}$$的概率没有被坐，那么那一个座位没有人坐的方案数就是$$\frac{(2(n+1))^m(n-m+1)}{n+1}=2^m(n+1)^{m-1}(n-m+1)$$。

太奇妙了。这个技巧被称为 合链成环，这样做目的是利用环的对称性。

-----

T2 midnight

不知道原题。可以在QingyuOJ http://oj.qingyu.us/problem/305 找到。

给两个基因串(只有AGCT)$$s,t$$，求它们的最长循环同构子序列，或者说求一个串使得它是$$t$$的子序列，并且它和$$s$$的某个子序列循环同构。$$\vert n\vert,\vert m\vert\leq 2000$$。

LCS先转最长路，循环先破环成链。

现在问题变成，$$(i,0)$$到$$(i+n-1,m)$$的最长路的$$\max$$。

我已知有两种做法，不过都需要单调性。

唐椰叶的做法是，猜测这些路径不会互相穿过，于是用神秘分治把它们全搞出来。

具体怎么神秘分治?考虑我们求出$$(mid,0)$$到$$(mid+n-1,m)$$的最长路，然后这条路径就会把这个网格图分成两部分，左边的路径就不可能经过右边(但是可能经过分界线)，右边的路径同理。所以维护一下这个图的形态，递归两边即可。复杂度$$O(nm\log n)$$。

官方题解做法是，用奇妙决策单调性，具体做法玄学，咕咕咕。

-----

T3 cicada

原题loj6499。

静态序列，每次查询若干区间的并中有多少颜色。$$n,v\leq 10^5$$，查询区间总个数不超过$$10^5$$，空间**8MB**。

爆力Bitset。

按$$B=\Theta(\frac{n}{w})$$大小分块，这样一共有$$w$$块。爆力预处理每块的Bitset，空间复杂度是$$O(n)$$。

然后考虑查询的时候怎么快速搞。你发现合并一遍复杂度是$$O(n)$$，绝对T飞了，所以我们需要预处理。

但是你又发现预处理一下空间是$$O(nw)$$，MLE飞了，所以我们需要......

st表!复杂度变成$$O(n\log w)$$，刚好卡过。复杂度$$O((n+q)\frac{n}{w})$$。

如果你的常数实在太大了，你发现后面还是T飞了。

诶T飞了吗?没飞，如果你试一试，发现可能好像只T了不到一倍的样子......不然就是你假了/cy

考虑一个常数优化，我们把所有只出现了一次的数搞出来前缀和统计，这样需要Bitset的值数量就只剩最多一半了，时空常数都变成一半，刚好可以通过。

-----

期望得分40+0+20，实际得分0+0+20。

T1实在不能切不掉啊......

### 讲课

数论/jy

-----

CC MAY15 Chef and Prime Divisors (CHAPD)

给$$a,b$$，把$$b$$所有质因子次数变成$$1$$得到$$b^\prime$$，问是否有$$b^\prime\vert a$$。$$a,b\leq 10^{18}$$，1e4组数据。

考虑如果我们不是给$$b$$降次，而是给$$a$$升次，貌似也能得到正确的结果。所以我们求$$a^{114514}\pmod{b}$$，如果是$$0$$说明可行。用快速乘+快速幂即可。

实际上那个次数不需要那么大，只需要到$$\log b$$即可。复杂度是$$O(T\log v\log\log v)$$。如果允许`__int128`或者认为`long double`快速乘是正确的，复杂度就是$$O(T\log\log v)$$。

-----

loj NOI Round #1 失控的未来交通工具

还是使用 最大xor路径 的套路。

考虑每个环可以无限的走，同时因为取膜可以走任意次，于是我们看到了一个裴蜀定理。所有$$\gcd(s_i,m)$$的倍数都可以被取到，当然这里$$s$$是环长。

然后我们求出随便一条$$u,v$$的路径，比方说权值和是$$l$$，那么接下来问题变成一个方程的解数计数 : $$x+bc\equiv l\pmod{m}$$。把$$x$$移过去解方程即可。

-----

SDOI2013 随机数生成器 加强版

不保证$$p$$是质数。

考虑这个式子最后会是什么$$k^nx_1+b\frac{k^{n}-1}{k-1}$$(后面是等比数列求和)，然后这个东西要同余于$$t$$。

乘过去

-----

WC2020 猜数游戏

-----

51nod1195 斐波那契数列的循环节

指数提升引理

斐波那契

-----

CC OCT13 Fibonacci Number (FN)

-----

IJPC2 Porter-Tele-Porter

-----

CF990G GCD Counting

-----

镜子

一个$$n\times m$$的棋盘，四周都是镜子，四角有接收器。现在从左下角发射一束激光，问它在被接收之前反射多少次。

这个问题太简单了，所以改成问你对于所有$$n\leq N,m\leq M$$，那个次数的和。$$N,M\leq 10^7$$，1e4组数据。

你打个表发现这个次数就是$$\frac{n+m}{\gcd(n,m)}-2$$，然后枚举$$\gcd$$硬莫反即可。

-----

lcm和gcd

https://shanlunjiajian.github.io/2021/04/05/a-problem-maybe-from-nowcoder/

又看了看好像做法一写错了......管他的（

-----

NOI2016 循环之美

这个结论挺小学奥数，但是我没见过......

$$k$$进制下$$\frac{x}{y}$$既约且纯循环等价于$$[x\perp y][y\perp k]$$。