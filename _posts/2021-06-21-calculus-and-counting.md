---
layout: post
title: 微积分和组合计数
subtitle: ¿
tags: 数学 生成函数
---

参考cmd 《多项式计数杂谈》，MiFaFaOvO 《A problem collection of ODE and differential technique》。

众所周知，处理生成函数的时候我们经常遇到导数和积分，常见的是三种情况 : 

 - EGF平移

 - OGF凑系数

 - 利用微积分发现性质

。

以下提到$$F^\prime$$之类的，默认是对$$z$$求导，否则会特殊说明或者使用$$\frac{\mathrm{d}...}{\mathrm{d}...}$$的记号。

-----

[排列](https://www.zhihu.com/question/393998538)

计数长为$$n$$，且没有两个相邻的数在数值上也相邻的排列数量。$$n\leq 10^7$$。

当然容斥。发现如果钦定$$k$$个不符合要求的间隔(就是让这些间隔两边的数在数值上相邻)，容斥系数就是$$(-1)^k$$。

然后考虑这样搞的方案数，发现有些钦定的间隔可能造成了一些连续段(呃就是对于每个钦定的间隔，我们把它两边的东西连起来)，每一段有两种排法，不过如果长为$$1$$则只有一种。如果长是$$l$$，它对容斥系数的贡献是$$(-1)^{l-1}$$(，这个情况对答案的贡献就是这些东西乘起来)。

考虑这么做 : 我们对于每一段求出它的OGF，然后直接枚举有多少段，做一个幂来拼接。这个OGF就是 : 

$$
T(z)=z+2\sum_{i=2}(-z)^{i-1}=z+2\frac{-z}{1+z}=\frac{z(1-z)}{1+z}
$$

至于拼接，我们考虑枚举段数，可以写出

$$·
G(z)=\sum_{i=0}i!z^i
$$

，这个东西含义是，对于每一段分配一个rank。$$F=G(T)$$就是答案的OGF。展开它!

$$
F(z)=\sum_{i=0}i!\frac{z^i(1-z)^i}{(1+z)^i}
$$

然后怎么办?直接算就是$$O(n^2\log n)$$，还不够好。

可以考虑搞一个方程来发现性质。

呃$$G$$里面那个$$i!$$的系数让人想到求导或者积分。先导一个试试。

$$
G^\prime (z)=\sum_{i=0}(i+1)!(i+1)z^i
$$

呃这个$$(i+1)!(i+1)$$是什么啊/yun

仔细想想，你发现$$(i+2)!=(i+1)!(i+2)$$，所以$$(i+1)!(i+1)=(i+2)!-(i+1)!$$。好像又凑出来了原来的系数?

呃等等，$$i+1,i+2$$很毒瘤，它们会导致$$-1,-2$$次项，我们还是避开这些奇怪的东西，转而使用用$$i-2,i-1$$吧。

我们做几个平移，然后减一减试一试。

$$
\begin{aligned}
z^2G^\prime(z)&=\sum_{i=2}(i-1)!(i-1)z^i\\
&=\sum_{i=2}(i!-(i-1)!)z^i\\
&=\sum_{i=2}i!z^i-\sum_{i=2}(i-1)!z^i\\
&=\sum_{i=2}i!z^i-\sum_{i=2}(i-1)!z^i\\
&=G(z)-1-z-(zG(z)-z)=G(z)-zG(z)-1
\end{aligned}
$$

看起来现在可以解ODE来得到$$G$$了，不过没有必要，因为这个方程已经提供了足够好的性质。

先硬代入一发$$T$$吧!

$$
\begin{aligned}
z^2G^\prime(z)&=G(z)-zG(z)-1\\
\frac{\mathrm{d}G(z)}{\mathrm{d}z}&=\frac{(1-z)G(z)-1}{z^2}\\
\frac{\mathrm{d}G(T(z))}{\mathrm{d}T(z)}&=\frac{(1-T(z))G(T(z))-1}{T(z)^2}\\
\frac{\mathrm{d}G(T(z))\cdot\mathrm{d}T(z)}{\mathrm{d}T(z)\cdot\mathrm{d}z}&=\frac{\mathrm{d}T(z)\cdot\Big((1-T(z))G(T(z))-1\Big)}{\mathrm{d}z\cdot T^2(z)}\\
F^\prime(z)&=T^\prime(z)\frac{(1-T(z))F(z)-1}{T^2(z)}\\
T^\prime(z)&=\frac{z^2+2z-1}{(1+z)^2},T^2(z)=\frac{z^2(1-z)^2}{(1+z)^2},1-T(z)=\frac{1+z^2}{1+z}\\
F^\prime(z)&=\frac{(z^2+2z-1)(1+z)^2}{(1+z)^2z^2(1-z)^2}\left(\frac{1+z^2}{1+z}F(z)-1\right)\\
&=\frac{z^2+2z-1}{z^4-2z^3+z^2}\left(\frac{1+z^2}{1+z}F(z)-1\right)\\
\end{aligned}
$$

你发现这个东西甚至没有卷积和幂之类的东西，可以直接提取系数得到递推式。呃这个过程太恶心了我并不想写......还是写一写吧。

先干掉分数，转成看起来可以提取系数的形式，然后直接两边取$$[z^n]$$ : 

$$
\begin{aligned}
(z^2-z^3-z^4+z^5)F^\prime(z)&=(1-2z-2z^3-z^4)F(z)-1+z+3z^2+z^3\\
 [z^n](z^2-z^3-z^4+z^5)F^\prime(z)&=[z^n](1-2z-2z^3-z^4)F(z)-[z^n]1+[z^n]z+[z^n]3z^2+[z^n]z^3\\
(n-1)f_{n-1}-(n-2)f_{n-2}-(n-3)f_{n-3}+(n-4)f_{n-4}&=f_n-2f_{n-1}-2f_{n-3}-f_{n-4}-[n=0]+[n=1]+3[n=2]+[n=3]\\
f_n&=(n+1)f_{n-1}-(n-2)f_{n-2}-(n-5)f_{n-3}+(n-3)f_{n-4}+[n=0]-[n=1]-3[n=2]-[n=3]\\
\end{aligned}
$$

这样就线性了。My math is toooooooooooo weak/ll

当然做这个题另一个简单的多的方法是OEIS（

你可以通过OEIS了解到，这个数列也是 在$$n\times n$$棋盘上摆$$n$$个互不攻击的王，并且每行每列恰好一个的方案数。这个好像完全一致所以没啥意思（

呃是不是可以直接推出这个递推式啊/ll

-----

一阶线性微分方程

都可以化成

$$
f^\prime(x)=a(x)f(x)+b(x)
$$

的形式。然后呢?

这个东西不能直接积分，所以考虑拿个东西把右边的$$f(x)$$扔到左边来变成同一个导数，容易想到使用积的求导法则。

想要搞出一个$$-a(x)$$，我们两边同乘$$e^{-\int a(x)}$$。然后就得到

$$
\begin{aligned}
f^\prime(x)e^{-\int a(x)}-f(x)a(x)e^{-\int a(x)}&=e^{-\int a(x)}b(x)\\
\frac{\mathrm{d}(f(x)e^{-\int a(x)})}{\mathrm{d}x}&=e^{-\int a(x)}b(x)\\
f(x)e^{-\int a(x)}&=\int e^{-\int a(x)}b(x)+C\\
f(x)&=e^{\int a(x)}\int e^{-\int a(x)}b(x)+C
\end{aligned}
$$

-----

[UR3 链式反应](https://uoj.ac/problem/50)

有根树，儿子无序，有红边和黄边。给定数集合$$A$$，计算有多少棵$$n$$个点的树，每个非叶节点满足

 - 有恰好两个儿子和它连红边

 - 有恰好$$k$$个儿子和它连黄边，其中$$k$$要在$$A$$中，并且这些儿子全是叶子

。$$n\leq 2\times 10^5$$，膜$$998244353$$。

呃卷起来了。显然枚举两条红边，然后剩下的都是黄边，然后这是一个卷积移一位，写成EGF就好了，注意儿子无序要除一个$$2$$。边界是单点，它肯定是叶子，注意空树为了方便看成不行。这里我就不写\hat了。

$$
\begin{aligned}
f_n&=[n=1]+\frac{1}{2}\sum_{i=1}\sum_{j=1}[n-i-j-1\in A]\binom{n-1}{i}\binom{n-1-i}{j}f_if_j\\
F(z)&=\frac{1}{2}\int A(z)F^2(z)+z
\end{aligned}
$$

现在你已经可以分治法法塔了!不过下面是一个$$1\log$$做法。

呃不定积分看起来不是很正常，我们还是换成导数吧。

$$
F^\prime(z)=\frac{1}{2}A(z)F^2(z)+1
$$

这里有卷积，就不能直接递推了。不过这是一阶微分方程，所以应该很好解!

然而如果你拿着一个数学软件，你会发现它解不动这个......

考虑一个倍增。类似于牛迭，我们发现右边是一个多项式，所以设$$f(F)=\frac{1}{2}AF^2-1$$。

然后假设已经求出膜$$z^n$$意义下的答案$$F_0$$，我们在$$F_0$$处把$$f$$泰勒展开 : 

$$
F^\prime&\equiv f(F_0)+f^\prime(F_0)(F-F_0)\pmod{z^{2n}}
$$

你发现$$f(F_0)$$是常多项式，所以这是一个......一阶线性微分方程!干翻它!

两边乘上$$e^{-\int f^\prime(F_0)}$$就可以解这个式子了，解出来我们得到$$F\equiv e^{\int f^\prime(F_0)}\int e^{-\int f^\prime(F_0)}f(F_0)+C$$。这个$$C$$咋办?你发现它的影响总是在常数项上，而常数项是什么我们懂的都懂 : 应该是$$0$$，所以它完全不重要。

复杂度还是$$T(n)=T(\frac{n}{2})+O(n\log n)=O(n\log n)$$，不过常数吓人，据说被$$O(n\log^2 n/\log\log n)$$吊着打。

-----

[UR19 通用测评号](https://uoj.ac/contest/51/problem/514)

有$$n$$个变量，一开始全是$$0$$，有上界$$a$$和阀值$$b$$。你每次随机选一个没有达到上界的让它$$+1$$，如果全都$$\geq b$$了就停止，求期望有多少个达到上界。$$n,a\leq 250$$，膜$$998244353$$。

考虑一个神奇操作 : 去掉不选满的的限制，转而统计最后$$\geq a$$的期望，因为这个过程是否停止和选不选满的没有关系。

然后就很简单了!根据期望的线性性，我们可以拆开每个变量，现在只考虑$$1$$最后$$\geq a$$的概率。

这个相当于在$$1$$达到$$a$$的时候，还有一些是$$<b$$的。我们可以进行容斥。

考虑如果我们钦定了$$k$$个当时$$<b$$的变量，容斥系数就是$$(-1)^k$$，概率......

呃可以这么考虑，我们忽略掉除了钦定的这些和$$1$$之外的所有变量，问题变成我每次随机一个$$0,...,k$$的数，问出现$$a$$个$$0$$的时候，其它数出现次数都$$<b$$的概率。

呃考虑如果除了$$0$$之外只有一个数，我们很容易计算这个东西。如果是两个数，我们需要枚举一个，然后组合数选一选确定两个数分别在哪些时刻被$$+1$$了......这是二项卷积啊朋友们!

考虑一个很简单的EGF : 

$$
T(z)=\sum_{i=0}^{b-1}\frac{z^i}{i!}
$$

那么我们就是要求所有$$T^k$$，算出这个剩下的部分随便推一推就好了。这个东西直接呐塔塔就可以做到$$O(n^3\log n)$$，这里认为$$n,a$$同阶。呃为什么不是$$O(n^2\log n)$$?因为幂有$$O(n^2)$$项，后面的东西我们还是要用的。

怎么砍这个$$\log$$?

呃看到幂就想到$$\exp$$，$$\exp$$要想不带$$\log$$就求导递推，同时EGF求导就是平移，所以可以求个导试一下?

你发现显然有$$T^\prime(z)=T(z)+\frac{z^{b-1}}{(b-1)!}$$，那么我们就知道

$$
\begin{aligned}
(T^n)^\prime(z)=nT^{n-1}(z)T^\prime(z)=nT^{n-1}(z)(T(z)+\frac{z^{b-1}}{(b-1)!})
\end{aligned}
$$

-----

中国象棋

退役了也不会写（